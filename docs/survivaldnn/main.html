<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.4"/>
    <title>survivaldnn.main API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>




            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#SurvivalDNNModel">SurvivalDNNModel</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#SurvivalDNNModel.__init__">SurvivalDNNModel</a>
                        </li>
                        <li>
                                <a class="variable" href="#SurvivalDNNModel.dtype">dtype</a>
                        </li>
                        <li>
                                <a class="variable" href="#SurvivalDNNModel.modelName">modelName</a>
                        </li>
                        <li>
                                <a class="variable" href="#SurvivalDNNModel.model">model</a>
                        </li>
                        <li>
                                <a class="variable" href="#SurvivalDNNModel.support">support</a>
                        </li>
                        <li>
                                <a class="variable" href="#SurvivalDNNModel.numSupport">numSupport</a>
                        </li>
                        <li>
                                <a class="variable" href="#SurvivalDNNModel.optimizer">optimizer</a>
                        </li>
                        <li>
                                <a class="variable" href="#SurvivalDNNModel.loss_fn">loss_fn</a>
                        </li>
                        <li>
                                <a class="variable" href="#SurvivalDNNModel.delayModelCompile">delayModelCompile</a>
                        </li>
                        <li>
                                <a class="variable" href="#SurvivalDNNModel.isCompiled">isCompiled</a>
                        </li>
                        <li>
                                <a class="function" href="#SurvivalDNNModel.compile">compile</a>
                        </li>
                        <li>
                                <a class="function" href="#SurvivalDNNModel.fit">fit</a>
                        </li>
                        <li>
                                <a class="function" href="#SurvivalDNNModel.predict_survival_function">predict_survival_function</a>
                        </li>
                        <li>
                                <a class="function" href="#SurvivalDNNModel.predict">predict</a>
                        </li>
                        <li>
                                <a class="function" href="#SurvivalDNNModel.predict_conditional">predict_conditional</a>
                        </li>
                        <li>
                                <a class="function" href="#SurvivalDNNModel.plot_survival_function">plot_survival_function</a>
                        </li>
                        <li>
                                <a class="function" href="#SurvivalDNNModel.plot_distribution">plot_distribution</a>
                        </li>
                        <li>
                                <a class="function" href="#SurvivalDNNModel.discretize_outcome_support">discretize_outcome_support</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#MonotoneProbabilities">MonotoneProbabilities</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#MonotoneProbabilities.__init__">MonotoneProbabilities</a>
                        </li>
                        <li>
                                <a class="variable" href="#MonotoneProbabilities.epsilon">epsilon</a>
                        </li>
                        <li>
                                <a class="function" href="#MonotoneProbabilities.call">call</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
survivaldnn<wbr>.main    </h1>

                
                        <input id="mod-main-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-main-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">survivaldnn.losses</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Callable</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">tensorflow</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">tf</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">tensorflow.keras</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">tfk</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">tf_compactprogbar</span><span class="w"> </span><span class="kn">import</span> <span class="n">CompactProgressBar</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="k">class</span><span class="w"> </span><span class="nc">SurvivalDNNModel</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="sd">    Random Survival DNN model for modeling the distribution of time-to-events</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">DType</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">):</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a>        
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">modelName</span> <span class="o">=</span> <span class="s1">&#39;SurvivalModel&#39;</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">support</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">numSupport</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">delayModelCompile</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">isCompiled</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a>                <span class="n">numFeatures</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a>                <span class="n">numSupport</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a>                <span class="n">loss</span> <span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]</span><span class="o">=</span><span class="s1">&#39;loglik&#39;</span><span class="p">,</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a>                <span class="n">architecture</span> <span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;resnet&#39;</span><span class="p">,</span> 
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a>                <span class="n">layers</span> <span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> 
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a>                <span class="n">activation</span> <span class="p">:</span> <span class="n">tfk</span><span class="o">.</span><span class="n">layers</span><span class="o">=</span><span class="n">tfk</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">,</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a>                <span class="n">batchnorm</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a>                <span class="n">dropout</span> <span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> 
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a>                <span class="n">l2</span> <span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> 
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a>                <span class="n">optimizer</span> <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">tfk</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Optimizer</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;adam&#39;</span><span class="p">,</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a>                <span class="n">lr</span> <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">tfk</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">schedules</span><span class="o">.</span><span class="n">LearningRateSchedule</span><span class="p">]</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a><span class="sd">        Compiles the Survival DNN model</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a><span class="sd">        Args:</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a><span class="sd">            numFeatures     (int)          Dimensionality of features</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a><span class="sd">            numSupport      (int)          Dimensionality of discretized outcome space</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="sd">            loss            (str, func)    Built-in loss function or a TensorFlow callable</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a><span class="sd">            architecture    (str, list)    Architecture. See note.</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a><span class="sd">            layers          (int)          Number of fixed-width hidden layers. Ignored if `architecture` != &#39;resnet&#39;</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a><span class="sd">            activation      (obj)          Activation function for hidden layers</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a><span class="sd">            batchnorm       (bool)         Whether to use batch normalization between each hidden layer</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a><span class="sd">            dropout         (float)        Dropout rate</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a><span class="sd">            l2              (float)        L2 regularization penalty on weights</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a><span class="sd">            optimizer       (str, obj)     TensorFlow Keras Optimizer</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a><span class="sd">        Notes: </span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a><span class="sd">            The `architecture` of the model defaults to a fixed-width DNN with residual connections,</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a><span class="sd">            with `layers` number of hidden layers. Either the number of hidden layers must be specified,</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a><span class="sd">            or an explicit architecture, e.g. [32, 32]</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a><span class="sd">            Built-in loss functions include: </span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a><span class="sd">                - &#39;loglik&#39;       Negative loglikelihood </span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a><span class="sd">                - &#39;mse&#39;          MSE of point estimates of E[Y|X] </span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a><span class="sd">                - &#39;loglik_mse&#39;   Composite loss of loglikelihood with shrinkage towards MSE</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a>        <span class="c1"># Parse configuration and user settings</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a>        <span class="k">if</span> <span class="n">architecture</span> <span class="o">==</span> <span class="s1">&#39;resnet&#39;</span><span class="p">:</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>            <span class="n">resnet</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>            <span class="n">numLayers</span> <span class="o">=</span> <span class="n">layers</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a>            <span class="n">layerNodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">numFeatures</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numLayers</span><span class="p">)]</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>            <span class="n">resnet</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a>            <span class="n">numLayers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">architecture</span><span class="p">)</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>            <span class="n">layerNodes</span> <span class="o">=</span> <span class="n">architecture</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>        <span class="k">if</span> <span class="n">loss</span> <span class="o">==</span> <span class="s1">&#39;loglik&#39;</span><span class="p">:</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span> <span class="o">=</span> <span class="n">loglik_loss</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a>        <span class="k">elif</span> <span class="n">loss</span> <span class="o">==</span> <span class="s1">&#39;mse&#39;</span><span class="p">:</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">delayModelCompile</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span> <span class="o">=</span> <span class="n">get_mse_loss</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>        <span class="k">elif</span> <span class="n">loss</span> <span class="o">==</span> <span class="s1">&#39;loglik_mse&#39;</span><span class="p">:</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">delayModelCompile</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span> <span class="o">=</span> <span class="n">get_loglik_mse_loss</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>        <span class="k">elif</span> <span class="nb">callable</span><span class="p">(</span><span class="n">loss</span><span class="p">):</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span> <span class="o">=</span> <span class="n">loss</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Invalid loss function. Must be in [&quot;loglik&quot;, &quot;mse&quot;, &quot;loglik_mse&quot;] or a callable function&#39;</span><span class="p">)</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">dropout</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batchnorm</span> <span class="o">=</span> <span class="n">batchnorm</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">numSupport</span> <span class="o">=</span> <span class="n">numSupport</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>        <span class="c1">## Model Architecture</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>        <span class="c1"># Input: Features</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>        <span class="n">featureLayer</span> <span class="o">=</span> <span class="n">tfk</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">numFeatures</span><span class="p">,))</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a>        <span class="n">f0</span> <span class="o">=</span> <span class="n">featureLayer</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a>        
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>        <span class="c1"># Hidden layers</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>        <span class="n">f</span> <span class="o">=</span> <span class="n">f0</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">nodes</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">layerNodes</span><span class="p">):</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>            <span class="n">lastLayer</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="p">(</span><span class="n">numLayers</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span> 
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a>                <span class="n">lastLayer</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>    
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a>            <span class="c1"># Feedforward connections</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a>            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_dense_layer</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">l2</span><span class="o">=</span><span class="n">l2</span><span class="p">)(</span><span class="n">f</span><span class="p">)</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>            <span class="k">if</span> <span class="n">batchnorm</span><span class="p">:</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a>                <span class="n">f</span> <span class="o">=</span> <span class="n">tfk</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)(</span><span class="n">f</span><span class="p">)</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>            <span class="n">f</span> <span class="o">=</span> <span class="n">activation</span><span class="p">()(</span><span class="n">f</span><span class="p">)</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>            <span class="c1"># Optional Dropout/Residual connections</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">lastLayer</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">dropout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>                <span class="n">f</span> <span class="o">=</span> <span class="n">tfk</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">)(</span><span class="n">f</span><span class="p">)</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>            <span class="k">if</span> <span class="n">resnet</span><span class="p">:</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>                <span class="n">f</span> <span class="o">=</span> <span class="n">tfk</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Add</span><span class="p">()([</span><span class="n">f</span><span class="p">,</span> <span class="n">f0</span><span class="p">])</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>            <span class="n">f</span> <span class="o">=</span> <span class="n">activation</span><span class="p">()(</span><span class="n">f</span><span class="p">)</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>    
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>        <span class="c1"># Pooling layer</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_dense_layer</span><span class="p">(</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">numSupport</span><span class="p">,</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>                    <span class="n">kernel_initializer</span><span class="o">=</span><span class="n">tfk</span><span class="o">.</span><span class="n">initializers</span><span class="o">.</span><span class="n">RandomNormal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>                <span class="p">)(</span><span class="n">f</span><span class="p">)</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>        <span class="c1"># Output: Conditional probabilities of survival P(T &gt;= t|X)</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a>        <span class="n">probs</span> <span class="o">=</span> <span class="n">MonotoneProbabilities</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)(</span><span class="n">f</span><span class="p">)</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">tfk</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">featureLayer</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">probs</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;SurvivalModel&#39;</span><span class="p">)</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>        <span class="c1">## Compile model</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>        <span class="k">if</span> <span class="n">optimizer</span> <span class="o">==</span> <span class="s1">&#39;adam&#39;</span><span class="p">:</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">tfk</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="n">clipnorm</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">delayModelCompile</span><span class="p">:</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_compile_model</span><span class="p">(</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>                <span class="n">optimizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="p">,</span> 
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>                <span class="n">loss_fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>            <span class="p">)</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">isCompiled</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span> <span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span> 
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>                  <span class="n">Y</span> <span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>                  <span class="n">val_data</span> <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a>                  <span class="n">epochs</span> <span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> 
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>                  <span class="n">batch_size</span> <span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> 
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a>                  <span class="n">tboard</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a>                  <span class="n">tboard_suffix</span> <span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a><span class="sd">        Trains the model</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a><span class="sd">        Args:</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a><span class="sd">            X              (array-like)    Features of shape (n, num_features)</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a><span class="sd">            Y              (array-like)    Outcomes/durations of shape (n,1) or (n,)</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a><span class="sd">            val_data       (tuple)         Validation data: (val_X, val_Y)</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a><span class="sd">            epochs         (int)           Number of training epochs</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a><span class="sd">            batch_size     (int)           Batch size</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a><span class="sd">            tboard         (bool)          Whether to profile with TensorBoard</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a><span class="sd">            tboard_suffix  (str)           Suffix on TensorBoard profile filenames</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a><span class="sd">        Outcomes should be an array of the duration/survival times for each individual. By default, the outcome space is discretized and</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a><span class="sd">        encoded into `support_bins` number of bins. Pass `None` to use all unique values as the support, e.g. for integer-valued outcomes.</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_check_compiled</span><span class="p">()</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>        
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>        <span class="c1"># Process data</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>        <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_features</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_outcomes</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>        <span class="n">hasVal</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>        <span class="k">if</span> <span class="n">val_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>            <span class="n">X_val</span><span class="p">,</span> <span class="n">Y_val</span> <span class="o">=</span> <span class="n">val_data</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>            <span class="n">X_val</span><span class="p">,</span> <span class="n">Y_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_features</span><span class="p">(</span><span class="n">X_val</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_outcomes</span><span class="p">(</span><span class="n">Y_val</span><span class="p">)</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>            <span class="n">hasVal</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>        <span class="c1"># Support of modeled distribution</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>        <span class="c1">## Bins: (t0, t1], (t1, t2], ..., (t_{k-1}, t-k]</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>        <span class="c1">##  where t_k = max(Y), t_0 = min(Y)</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">support</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>            <span class="k">if</span> <span class="n">hasVal</span><span class="p">:</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a>                <span class="n">Y_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">Y</span><span class="p">,</span> <span class="n">Y_val</span><span class="p">])</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>                <span class="n">Y_full</span> <span class="o">=</span> <span class="n">Y</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">support</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">discretize_outcome_support</span><span class="p">(</span><span class="n">Y_full</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">numSupport</span><span class="p">)</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a>        <span class="c1"># Delayed compilation if necessary</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delayModelCompile</span><span class="p">:</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_compile_model</span><span class="p">(</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>                <span class="n">optimizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="p">,</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>                <span class="n">loss_fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">support</span><span class="p">)</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>            <span class="p">)</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">delayModelCompile</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a>        
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>        <span class="c1"># Encode outcomes</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>        <span class="n">Y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encode_outcomes</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>        <span class="k">if</span> <span class="n">hasVal</span><span class="p">:</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>            <span class="n">Y_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encode_outcomes</span><span class="p">(</span><span class="n">Y_val</span><span class="p">)</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a>            <span class="n">val_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">X_val</span><span class="p">,</span> <span class="n">Y_val</span><span class="p">)</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a>        <span class="c1"># Train model</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>        <span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>                      <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>                      <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>                      <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>                      <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>                      <span class="n">validation_data</span><span class="o">=</span><span class="n">val_data</span><span class="p">,</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a>                      <span class="n">callbacks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_callbacks</span><span class="p">(</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a>                                    <span class="n">hasVal</span><span class="o">=</span><span class="n">hasVal</span><span class="p">,</span> 
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>                                    <span class="n">tboard</span><span class="o">=</span><span class="n">tboard</span><span class="p">,</span> 
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a>                                    <span class="n">tboard_suffix</span><span class="o">=</span><span class="n">tboard_suffix</span><span class="p">,</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>                                <span class="p">)</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>                    <span class="p">)</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">history</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>        
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>        <span class="c1"># Post-training: Update batch norm statistics without dropout (Hendrycks and Gimpel, 2017)</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batchnorm</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_toggle_dropout</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">):</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a>                <span class="n">X_batch</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">idx</span><span class="p">:(</span><span class="n">idx</span><span class="o">+</span><span class="n">batch_size</span><span class="p">),</span> <span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">X_batch</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_toggle_dropout</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>     
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">predict_survival_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">2000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a><span class="sd">        Predicts the full survival function S(t|X) = P(T &gt;= t|X)</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a><span class="sd">        Returns:</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a><span class="sd">            survFunc  (np.array)  Evaluation of survival function on support, shape (n, numSupport)</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a><span class="sd">            support   (np.array)  Support points of t, shape (numSupport)</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_check_compiled</span><span class="p">()</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a>        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_features</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a>        
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a>        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>        <span class="n">survFunc</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a>            
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a>            <span class="c1"># Estimates of conditional probabilities P(T &gt;= t | X)</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>            <span class="n">X_batch</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">idx</span><span class="p">:(</span><span class="n">idx</span><span class="o">+</span><span class="n">batch_size</span><span class="p">),</span> <span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>            <span class="n">condProbs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">X_batch</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>            
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>            <span class="c1"># Estimates of survival function</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>            <span class="n">survFunc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">condProbs</span><span class="p">)</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>        <span class="n">survFunc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">survFunc</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>        <span class="n">support</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_support</span><span class="p">()</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>        <span class="k">return</span> <span class="n">survFunc</span><span class="p">,</span> <span class="n">support</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a>    
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">2000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a><span class="sd">        Estimate the expected time-to-event, E[Y|X]</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a><span class="sd">        Args:</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a><span class="sd">            X           (array-like)    Features of shape (n, numFeatures)</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a><span class="sd">            method      (str)           Integration by &#39;midpoint&#39; or &#39;right&#39;</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a><span class="sd">            batch_size  (int)           Batch size</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_check_compiled</span><span class="p">()</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a>        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_features</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>        <span class="n">support</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_support</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>        <span class="n">Y_hat</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>            <span class="n">X_batch</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">idx</span><span class="p">:(</span><span class="n">idx</span><span class="o">+</span><span class="n">batch_size</span><span class="p">),</span> <span class="p">:]</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>        
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>            <span class="c1"># Estimated survival function: P(T &gt;= t| X)</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>            <span class="n">survFunc</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_survival_function</span><span class="p">(</span><span class="n">X_batch</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>    
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>            <span class="c1"># Estimated PMF: P(T = t|X)</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>            <span class="n">probs</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">survFunc</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>    
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>            <span class="c1"># Expected time-to-event</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>            <span class="n">Y_hat_batch</span> <span class="o">=</span> <span class="n">probs</span> <span class="o">@</span> <span class="n">support</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>            <span class="n">Y_hat</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Y_hat_batch</span><span class="p">))</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Y_hat</span><span class="p">))</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">predict_conditional</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">elapsed</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">2000</span><span class="p">):</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a><span class="sd">        Estimate the expected time-to-event conditional on elapsed, E[Y|X, Y &gt;= elapsed]</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a><span class="sd">        Args:</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a><span class="sd">            X           (array-like)    Features of shape (n, numFeatures)</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a><span class="sd">            elapsed     (array-like)    Array of shape (n,) indicating elapsed times</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a><span class="sd">            method      (str)           Integration by &#39;midpoint&#39; or &#39;right&#39;</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a><span class="sd">            batch_size  (int)           Batch size</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_check_compiled</span><span class="p">()</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>        <span class="n">X</span><span class="p">,</span> <span class="n">elapsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_features</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_outcomes</span><span class="p">(</span><span class="n">elapsed</span><span class="p">)</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">elapsed</span><span class="p">):</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Mismatched shapes. Received </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="si">}</span><span class="s1"> features and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">elapsed</span><span class="p">)</span><span class="si">}</span><span class="s1"> times.&#39;</span><span class="p">)</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>        <span class="n">support</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_support</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>        <span class="n">Y_hat</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>            <span class="n">X_batch</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">idx</span><span class="p">:(</span><span class="n">idx</span><span class="o">+</span><span class="n">batch_size</span><span class="p">),</span> <span class="p">:]</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>            <span class="n">elapsed_batch</span> <span class="o">=</span> <span class="n">elapsed</span><span class="p">[</span><span class="n">idx</span><span class="p">:(</span><span class="n">idx</span><span class="o">+</span><span class="n">batch_size</span><span class="p">)]</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>        
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a>            <span class="c1"># Estimated survival function: P(T &gt;= t|X)</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>            <span class="n">survFunc</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_survival_function</span><span class="p">(</span><span class="n">X_batch</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>    
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>            <span class="c1"># Estimated PMF: P(T = t|X)</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>            <span class="n">probs</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">survFunc</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>            <span class="c1"># Zero-indexed indicator for support bins</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>            <span class="n">elapsed_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">elapsed_batch</span><span class="p">,</span> <span class="n">support</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">support</span><span class="p">))</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>            <span class="c1"># Expected conditional time-to-event</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>            <span class="n">Y_hat_batch</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">bin_idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">elapsed_idx</span><span class="p">):</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a>                <span class="n">truncated_probs</span> <span class="o">=</span> <span class="n">probs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">bin_idx</span><span class="p">:]</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>                <span class="n">truncated_support</span> <span class="o">=</span> <span class="n">support</span><span class="p">[</span><span class="n">bin_idx</span><span class="p">:]</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>                <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">truncated_probs</span> <span class="o">@</span> <span class="n">truncated_support</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">truncated_probs</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>                <span class="n">Y_hat_batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>            <span class="n">Y_hat</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Y_hat_batch</span><span class="p">))</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Y_hat</span><span class="p">))</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_survival_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a><span class="sd">        Plots the survival function</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>        <span class="n">survFunc</span><span class="p">,</span> <span class="n">support</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_survival_function</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">survFunc</span><span class="p">):</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">support</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s2">&quot;post&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Survival Probability&quot;</span><span class="p">)</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time&quot;</span><span class="p">)</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_distribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a><span class="sd">        Plots the CDF P(T&lt;=t|X)</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>        <span class="n">survFunc</span><span class="p">,</span> <span class="n">support</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_survival_function</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>        <span class="n">F</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">survFunc</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">Fn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">F</span><span class="p">):</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">support</span><span class="p">,</span> <span class="n">Fn</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s2">&quot;post&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;CDF&quot;</span><span class="p">)</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time&quot;</span><span class="p">)</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">discretize_outcome_support</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Y</span> <span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span> <span class="n">numSupport</span> <span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a><span class="sd">        Gets the discretized support of the outcome space</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a><span class="sd">        Args:</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a><span class="sd">            Y               (array-like)    Outcome durations of interest</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a><span class="sd">            numSupport      (int)           Number of support bins. Pass `None` to use all unique integer values as support    </span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>        <span class="k">if</span> <span class="n">numSupport</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>            <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">Y</span><span class="p">)))</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>            <span class="n">_</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">numSupport</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">retbins</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>   <span class="c1"># Note: These are left-open endpoints, (t0, t1], (t1, t2], ...</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>        <span class="k">return</span> <span class="n">bins</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_create_dense_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">kernel_initializer</span><span class="o">=</span><span class="s1">&#39;he_normal&#39;</span><span class="p">,</span> <span class="n">l2</span> <span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a><span class="sd">        Standard fully-connected layer</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>        <span class="n">regularizer</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>        <span class="k">if</span> <span class="n">l2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>            <span class="n">regularizer</span> <span class="o">=</span> <span class="n">tfk</span><span class="o">.</span><span class="n">regularizers</span><span class="o">.</span><span class="n">L2</span><span class="p">(</span><span class="n">l2</span><span class="p">)</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>        <span class="n">layer</span> <span class="o">=</span> <span class="n">tfk</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>                             <span class="n">kernel_initializer</span><span class="o">=</span><span class="n">kernel_initializer</span><span class="p">,</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>                             <span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">regularizer</span><span class="p">,</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>                             <span class="n">bias_initializer</span><span class="o">=</span><span class="n">tfk</span><span class="o">.</span><span class="n">initializers</span><span class="o">.</span><span class="n">RandomNormal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">),</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a>                             <span class="n">name</span><span class="o">=</span><span class="n">name</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>                            <span class="p">)</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>        <span class="k">return</span> <span class="n">layer</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_compile_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">loss_fn</span><span class="p">):</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>                <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>                <span class="n">loss</span><span class="o">=</span><span class="n">loss_fn</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>            <span class="p">)</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">isCompiled</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_process_outcomes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a><span class="sd">        Discretizes and flattens outcomes</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a><span class="sd">        Args:</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a><span class="sd">            - Y  (array-like)  DataFrame/Array with a single column of shape (n,1) or (n,)</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>            <span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">values</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>        <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tensor</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_encode_outcomes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a><span class="sd">        Encodes outcomes in discrete-time bins for survival/failure</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a><span class="sd">        Ex.</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a><span class="sd">         Y = [3,1,2] -&gt;  support = [1,2,3]</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a><span class="sd">                         Y_enc = [[1,1,1],[1,0,0,],[1,1,0]]</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a><span class="sd">        Returns:</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a><span class="sd">            Y_encoded (np.array) of shape (n, numSupport)</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>        <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>        
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>        <span class="c1"># Zero-indexed indicator for support bins</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a>        <span class="n">Y_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">support</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">support</span><span class="p">))</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>        <span class="c1"># Encoded arrays for survival</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a>        <span class="n">Y_enc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">support</span><span class="p">)))</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">support</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="n">Y_idx</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>        <span class="n">Y_enc</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a>        <span class="k">return</span> <span class="n">Y_enc</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a>        
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_process_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a>            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">values</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tensor</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>    
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>        <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_check_compiled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isCompiled</span><span class="p">:</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Model must be compiled first!&#39;</span><span class="p">)</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hasVal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tboard</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tboard_suffix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">min_delta</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>  
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a><span class="sd">        Returns a list of callbacks for training</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>        <span class="n">callbacks</span> <span class="o">=</span> <span class="p">[</span><span class="n">CompactProgressBar</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;lr&#39;</span><span class="p">]),]</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a>        <span class="k">if</span> <span class="n">hasVal</span><span class="p">:</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a>            <span class="n">callbacks</span> <span class="o">+=</span> <span class="p">[</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>                <span class="n">tfk</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">EarlyStopping</span><span class="p">(</span><span class="n">min_delta</span><span class="o">=</span><span class="n">min_delta</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">restore_best_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a>                <span class="n">tfk</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">ReduceLROnPlateau</span><span class="p">(</span><span class="n">min_delta</span><span class="o">=</span><span class="n">min_delta</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">20</span><span class="p">),</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a>            <span class="p">]</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>        <span class="k">if</span> <span class="n">tboard</span><span class="p">:</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a>            <span class="n">currTime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">_%H-%M-%S&quot;</span><span class="p">)</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a>            <span class="n">log_dir</span> <span class="o">=</span> <span class="s1">&#39;logs/&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">currTime</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">modelName</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">tboard_suffix</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a>            <span class="n">callbacks</span> <span class="o">+=</span> <span class="p">[</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>                <span class="n">tfk</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">TensorBoard</span><span class="p">(</span><span class="n">log_dir</span><span class="o">=</span><span class="n">log_dir</span><span class="p">,</span> <span class="n">write_graph</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">histogram_freq</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a>            <span class="p">]</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a>        <span class="k">return</span> <span class="n">callbacks</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_toggle_dropout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a><span class="sd">        Toggles dropout layers on and off</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_check_compiled</span><span class="p">()</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">tfk</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">):</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>                <span class="k">if</span> <span class="n">mode</span><span class="p">:</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>                    <span class="n">rate</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">)</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>                    <span class="n">rate</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>                <span class="n">layer</span><span class="o">.</span><span class="n">rate</span> <span class="o">=</span> <span class="n">rate</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_support</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">):</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a><span class="sd">        Returns the support of the modeled distribution for T </span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_check_compiled</span><span class="p">()</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a>        <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="s1">&#39;right&#39;</span><span class="p">:</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a>            <span class="n">support</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">support</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>        <span class="k">elif</span> <span class="n">method</span><span class="o">==</span><span class="s1">&#39;midpoint&#39;</span><span class="p">:</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a>            <span class="n">support</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">support</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">support</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a>        <span class="k">return</span> <span class="n">support</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a><span class="k">class</span><span class="w"> </span><span class="nc">MonotoneProbabilities</span><span class="p">(</span><span class="n">tfk</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Layer</span><span class="p">):</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a><span class="sd">    Output layer that enforces monotonically decreasing shape restrictions as probabilities</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">DType</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>        <span class="nb">super</span><span class="p">(</span><span class="n">MonotoneProbabilities</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>    
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a><span class="sd">        Inputs to layer should be all of R</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>        <span class="c1"># Monotonicity transformation</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>               <span class="c1"># Larger |x| -&gt; Smaller prob.</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">)</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>        <span class="k">return</span> <span class="n">x</span>
</span></pre></div>


            </section>
                <section id="SurvivalDNNModel">
                            <input id="SurvivalDNNModel-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">SurvivalDNNModel</span><wbr>(<span class="base">tensorflow.python.module.module.Module</span>):

                <label class="view-source-button" for="SurvivalDNNModel-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SurvivalDNNModel"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SurvivalDNNModel-13"><a href="#SurvivalDNNModel-13"><span class="linenos"> 13</span></a><span class="k">class</span><span class="w"> </span><span class="nc">SurvivalDNNModel</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="SurvivalDNNModel-14"><a href="#SurvivalDNNModel-14"><span class="linenos"> 14</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SurvivalDNNModel-15"><a href="#SurvivalDNNModel-15"><span class="linenos"> 15</span></a><span class="sd">    Random Survival DNN model for modeling the distribution of time-to-events</span>
</span><span id="SurvivalDNNModel-16"><a href="#SurvivalDNNModel-16"><span class="linenos"> 16</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="SurvivalDNNModel-17"><a href="#SurvivalDNNModel-17"><span class="linenos"> 17</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">DType</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">):</span>
</span><span id="SurvivalDNNModel-18"><a href="#SurvivalDNNModel-18"><span class="linenos"> 18</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span>
</span><span id="SurvivalDNNModel-19"><a href="#SurvivalDNNModel-19"><span class="linenos"> 19</span></a>        
</span><span id="SurvivalDNNModel-20"><a href="#SurvivalDNNModel-20"><span class="linenos"> 20</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">modelName</span> <span class="o">=</span> <span class="s1">&#39;SurvivalModel&#39;</span>
</span><span id="SurvivalDNNModel-21"><a href="#SurvivalDNNModel-21"><span class="linenos"> 21</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SurvivalDNNModel-22"><a href="#SurvivalDNNModel-22"><span class="linenos"> 22</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">support</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SurvivalDNNModel-23"><a href="#SurvivalDNNModel-23"><span class="linenos"> 23</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">numSupport</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SurvivalDNNModel-24"><a href="#SurvivalDNNModel-24"><span class="linenos"> 24</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SurvivalDNNModel-25"><a href="#SurvivalDNNModel-25"><span class="linenos"> 25</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SurvivalDNNModel-26"><a href="#SurvivalDNNModel-26"><span class="linenos"> 26</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">delayModelCompile</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="SurvivalDNNModel-27"><a href="#SurvivalDNNModel-27"><span class="linenos"> 27</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">isCompiled</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="SurvivalDNNModel-28"><a href="#SurvivalDNNModel-28"><span class="linenos"> 28</span></a>
</span><span id="SurvivalDNNModel-29"><a href="#SurvivalDNNModel-29"><span class="linenos"> 29</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
</span><span id="SurvivalDNNModel-30"><a href="#SurvivalDNNModel-30"><span class="linenos"> 30</span></a>                <span class="n">numFeatures</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
</span><span id="SurvivalDNNModel-31"><a href="#SurvivalDNNModel-31"><span class="linenos"> 31</span></a>                <span class="n">numSupport</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="SurvivalDNNModel-32"><a href="#SurvivalDNNModel-32"><span class="linenos"> 32</span></a>                <span class="n">loss</span> <span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]</span><span class="o">=</span><span class="s1">&#39;loglik&#39;</span><span class="p">,</span>
</span><span id="SurvivalDNNModel-33"><a href="#SurvivalDNNModel-33"><span class="linenos"> 33</span></a>                <span class="n">architecture</span> <span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;resnet&#39;</span><span class="p">,</span> 
</span><span id="SurvivalDNNModel-34"><a href="#SurvivalDNNModel-34"><span class="linenos"> 34</span></a>                <span class="n">layers</span> <span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> 
</span><span id="SurvivalDNNModel-35"><a href="#SurvivalDNNModel-35"><span class="linenos"> 35</span></a>                <span class="n">activation</span> <span class="p">:</span> <span class="n">tfk</span><span class="o">.</span><span class="n">layers</span><span class="o">=</span><span class="n">tfk</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">,</span>
</span><span id="SurvivalDNNModel-36"><a href="#SurvivalDNNModel-36"><span class="linenos"> 36</span></a>                <span class="n">batchnorm</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="SurvivalDNNModel-37"><a href="#SurvivalDNNModel-37"><span class="linenos"> 37</span></a>                <span class="n">dropout</span> <span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> 
</span><span id="SurvivalDNNModel-38"><a href="#SurvivalDNNModel-38"><span class="linenos"> 38</span></a>                <span class="n">l2</span> <span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> 
</span><span id="SurvivalDNNModel-39"><a href="#SurvivalDNNModel-39"><span class="linenos"> 39</span></a>                <span class="n">optimizer</span> <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">tfk</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Optimizer</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;adam&#39;</span><span class="p">,</span>
</span><span id="SurvivalDNNModel-40"><a href="#SurvivalDNNModel-40"><span class="linenos"> 40</span></a>                <span class="n">lr</span> <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">tfk</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">schedules</span><span class="o">.</span><span class="n">LearningRateSchedule</span><span class="p">]</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
</span><span id="SurvivalDNNModel-41"><a href="#SurvivalDNNModel-41"><span class="linenos"> 41</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SurvivalDNNModel-42"><a href="#SurvivalDNNModel-42"><span class="linenos"> 42</span></a><span class="sd">        Compiles the Survival DNN model</span>
</span><span id="SurvivalDNNModel-43"><a href="#SurvivalDNNModel-43"><span class="linenos"> 43</span></a>
</span><span id="SurvivalDNNModel-44"><a href="#SurvivalDNNModel-44"><span class="linenos"> 44</span></a><span class="sd">        Args:</span>
</span><span id="SurvivalDNNModel-45"><a href="#SurvivalDNNModel-45"><span class="linenos"> 45</span></a><span class="sd">            numFeatures     (int)          Dimensionality of features</span>
</span><span id="SurvivalDNNModel-46"><a href="#SurvivalDNNModel-46"><span class="linenos"> 46</span></a><span class="sd">            numSupport      (int)          Dimensionality of discretized outcome space</span>
</span><span id="SurvivalDNNModel-47"><a href="#SurvivalDNNModel-47"><span class="linenos"> 47</span></a><span class="sd">            loss            (str, func)    Built-in loss function or a TensorFlow callable</span>
</span><span id="SurvivalDNNModel-48"><a href="#SurvivalDNNModel-48"><span class="linenos"> 48</span></a><span class="sd">            architecture    (str, list)    Architecture. See note.</span>
</span><span id="SurvivalDNNModel-49"><a href="#SurvivalDNNModel-49"><span class="linenos"> 49</span></a><span class="sd">            layers          (int)          Number of fixed-width hidden layers. Ignored if `architecture` != &#39;resnet&#39;</span>
</span><span id="SurvivalDNNModel-50"><a href="#SurvivalDNNModel-50"><span class="linenos"> 50</span></a><span class="sd">            activation      (obj)          Activation function for hidden layers</span>
</span><span id="SurvivalDNNModel-51"><a href="#SurvivalDNNModel-51"><span class="linenos"> 51</span></a><span class="sd">            batchnorm       (bool)         Whether to use batch normalization between each hidden layer</span>
</span><span id="SurvivalDNNModel-52"><a href="#SurvivalDNNModel-52"><span class="linenos"> 52</span></a><span class="sd">            dropout         (float)        Dropout rate</span>
</span><span id="SurvivalDNNModel-53"><a href="#SurvivalDNNModel-53"><span class="linenos"> 53</span></a><span class="sd">            l2              (float)        L2 regularization penalty on weights</span>
</span><span id="SurvivalDNNModel-54"><a href="#SurvivalDNNModel-54"><span class="linenos"> 54</span></a><span class="sd">            optimizer       (str, obj)     TensorFlow Keras Optimizer</span>
</span><span id="SurvivalDNNModel-55"><a href="#SurvivalDNNModel-55"><span class="linenos"> 55</span></a>
</span><span id="SurvivalDNNModel-56"><a href="#SurvivalDNNModel-56"><span class="linenos"> 56</span></a><span class="sd">        Notes: </span>
</span><span id="SurvivalDNNModel-57"><a href="#SurvivalDNNModel-57"><span class="linenos"> 57</span></a><span class="sd">            The `architecture` of the model defaults to a fixed-width DNN with residual connections,</span>
</span><span id="SurvivalDNNModel-58"><a href="#SurvivalDNNModel-58"><span class="linenos"> 58</span></a><span class="sd">            with `layers` number of hidden layers. Either the number of hidden layers must be specified,</span>
</span><span id="SurvivalDNNModel-59"><a href="#SurvivalDNNModel-59"><span class="linenos"> 59</span></a><span class="sd">            or an explicit architecture, e.g. [32, 32]</span>
</span><span id="SurvivalDNNModel-60"><a href="#SurvivalDNNModel-60"><span class="linenos"> 60</span></a>
</span><span id="SurvivalDNNModel-61"><a href="#SurvivalDNNModel-61"><span class="linenos"> 61</span></a><span class="sd">            Built-in loss functions include: </span>
</span><span id="SurvivalDNNModel-62"><a href="#SurvivalDNNModel-62"><span class="linenos"> 62</span></a><span class="sd">                - &#39;loglik&#39;       Negative loglikelihood </span>
</span><span id="SurvivalDNNModel-63"><a href="#SurvivalDNNModel-63"><span class="linenos"> 63</span></a><span class="sd">                - &#39;mse&#39;          MSE of point estimates of E[Y|X] </span>
</span><span id="SurvivalDNNModel-64"><a href="#SurvivalDNNModel-64"><span class="linenos"> 64</span></a><span class="sd">                - &#39;loglik_mse&#39;   Composite loss of loglikelihood with shrinkage towards MSE</span>
</span><span id="SurvivalDNNModel-65"><a href="#SurvivalDNNModel-65"><span class="linenos"> 65</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SurvivalDNNModel-66"><a href="#SurvivalDNNModel-66"><span class="linenos"> 66</span></a>        <span class="c1"># Parse configuration and user settings</span>
</span><span id="SurvivalDNNModel-67"><a href="#SurvivalDNNModel-67"><span class="linenos"> 67</span></a>        <span class="k">if</span> <span class="n">architecture</span> <span class="o">==</span> <span class="s1">&#39;resnet&#39;</span><span class="p">:</span>
</span><span id="SurvivalDNNModel-68"><a href="#SurvivalDNNModel-68"><span class="linenos"> 68</span></a>            <span class="n">resnet</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="SurvivalDNNModel-69"><a href="#SurvivalDNNModel-69"><span class="linenos"> 69</span></a>            <span class="n">numLayers</span> <span class="o">=</span> <span class="n">layers</span>
</span><span id="SurvivalDNNModel-70"><a href="#SurvivalDNNModel-70"><span class="linenos"> 70</span></a>            <span class="n">layerNodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">numFeatures</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numLayers</span><span class="p">)]</span>
</span><span id="SurvivalDNNModel-71"><a href="#SurvivalDNNModel-71"><span class="linenos"> 71</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SurvivalDNNModel-72"><a href="#SurvivalDNNModel-72"><span class="linenos"> 72</span></a>            <span class="n">resnet</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="SurvivalDNNModel-73"><a href="#SurvivalDNNModel-73"><span class="linenos"> 73</span></a>            <span class="n">numLayers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">architecture</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-74"><a href="#SurvivalDNNModel-74"><span class="linenos"> 74</span></a>            <span class="n">layerNodes</span> <span class="o">=</span> <span class="n">architecture</span>
</span><span id="SurvivalDNNModel-75"><a href="#SurvivalDNNModel-75"><span class="linenos"> 75</span></a>        <span class="k">if</span> <span class="n">loss</span> <span class="o">==</span> <span class="s1">&#39;loglik&#39;</span><span class="p">:</span>
</span><span id="SurvivalDNNModel-76"><a href="#SurvivalDNNModel-76"><span class="linenos"> 76</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span> <span class="o">=</span> <span class="n">loglik_loss</span>
</span><span id="SurvivalDNNModel-77"><a href="#SurvivalDNNModel-77"><span class="linenos"> 77</span></a>        <span class="k">elif</span> <span class="n">loss</span> <span class="o">==</span> <span class="s1">&#39;mse&#39;</span><span class="p">:</span>
</span><span id="SurvivalDNNModel-78"><a href="#SurvivalDNNModel-78"><span class="linenos"> 78</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">delayModelCompile</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="SurvivalDNNModel-79"><a href="#SurvivalDNNModel-79"><span class="linenos"> 79</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span> <span class="o">=</span> <span class="n">get_mse_loss</span>
</span><span id="SurvivalDNNModel-80"><a href="#SurvivalDNNModel-80"><span class="linenos"> 80</span></a>        <span class="k">elif</span> <span class="n">loss</span> <span class="o">==</span> <span class="s1">&#39;loglik_mse&#39;</span><span class="p">:</span>
</span><span id="SurvivalDNNModel-81"><a href="#SurvivalDNNModel-81"><span class="linenos"> 81</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">delayModelCompile</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="SurvivalDNNModel-82"><a href="#SurvivalDNNModel-82"><span class="linenos"> 82</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span> <span class="o">=</span> <span class="n">get_loglik_mse_loss</span>
</span><span id="SurvivalDNNModel-83"><a href="#SurvivalDNNModel-83"><span class="linenos"> 83</span></a>        <span class="k">elif</span> <span class="nb">callable</span><span class="p">(</span><span class="n">loss</span><span class="p">):</span>
</span><span id="SurvivalDNNModel-84"><a href="#SurvivalDNNModel-84"><span class="linenos"> 84</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span> <span class="o">=</span> <span class="n">loss</span>
</span><span id="SurvivalDNNModel-85"><a href="#SurvivalDNNModel-85"><span class="linenos"> 85</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SurvivalDNNModel-86"><a href="#SurvivalDNNModel-86"><span class="linenos"> 86</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Invalid loss function. Must be in [&quot;loglik&quot;, &quot;mse&quot;, &quot;loglik_mse&quot;] or a callable function&#39;</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-87"><a href="#SurvivalDNNModel-87"><span class="linenos"> 87</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">dropout</span>
</span><span id="SurvivalDNNModel-88"><a href="#SurvivalDNNModel-88"><span class="linenos"> 88</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batchnorm</span> <span class="o">=</span> <span class="n">batchnorm</span>
</span><span id="SurvivalDNNModel-89"><a href="#SurvivalDNNModel-89"><span class="linenos"> 89</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">numSupport</span> <span class="o">=</span> <span class="n">numSupport</span>
</span><span id="SurvivalDNNModel-90"><a href="#SurvivalDNNModel-90"><span class="linenos"> 90</span></a>
</span><span id="SurvivalDNNModel-91"><a href="#SurvivalDNNModel-91"><span class="linenos"> 91</span></a>        <span class="c1">## Model Architecture</span>
</span><span id="SurvivalDNNModel-92"><a href="#SurvivalDNNModel-92"><span class="linenos"> 92</span></a>
</span><span id="SurvivalDNNModel-93"><a href="#SurvivalDNNModel-93"><span class="linenos"> 93</span></a>        <span class="c1"># Input: Features</span>
</span><span id="SurvivalDNNModel-94"><a href="#SurvivalDNNModel-94"><span class="linenos"> 94</span></a>        <span class="n">featureLayer</span> <span class="o">=</span> <span class="n">tfk</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">numFeatures</span><span class="p">,))</span>
</span><span id="SurvivalDNNModel-95"><a href="#SurvivalDNNModel-95"><span class="linenos"> 95</span></a>        <span class="n">f0</span> <span class="o">=</span> <span class="n">featureLayer</span>
</span><span id="SurvivalDNNModel-96"><a href="#SurvivalDNNModel-96"><span class="linenos"> 96</span></a>        
</span><span id="SurvivalDNNModel-97"><a href="#SurvivalDNNModel-97"><span class="linenos"> 97</span></a>        <span class="c1"># Hidden layers</span>
</span><span id="SurvivalDNNModel-98"><a href="#SurvivalDNNModel-98"><span class="linenos"> 98</span></a>        <span class="n">f</span> <span class="o">=</span> <span class="n">f0</span>
</span><span id="SurvivalDNNModel-99"><a href="#SurvivalDNNModel-99"><span class="linenos"> 99</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">nodes</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">layerNodes</span><span class="p">):</span>
</span><span id="SurvivalDNNModel-100"><a href="#SurvivalDNNModel-100"><span class="linenos">100</span></a>            <span class="n">lastLayer</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="SurvivalDNNModel-101"><a href="#SurvivalDNNModel-101"><span class="linenos">101</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="p">(</span><span class="n">numLayers</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span> 
</span><span id="SurvivalDNNModel-102"><a href="#SurvivalDNNModel-102"><span class="linenos">102</span></a>                <span class="n">lastLayer</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="SurvivalDNNModel-103"><a href="#SurvivalDNNModel-103"><span class="linenos">103</span></a>    
</span><span id="SurvivalDNNModel-104"><a href="#SurvivalDNNModel-104"><span class="linenos">104</span></a>            <span class="c1"># Feedforward connections</span>
</span><span id="SurvivalDNNModel-105"><a href="#SurvivalDNNModel-105"><span class="linenos">105</span></a>            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_dense_layer</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">l2</span><span class="o">=</span><span class="n">l2</span><span class="p">)(</span><span class="n">f</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-106"><a href="#SurvivalDNNModel-106"><span class="linenos">106</span></a>            <span class="k">if</span> <span class="n">batchnorm</span><span class="p">:</span>
</span><span id="SurvivalDNNModel-107"><a href="#SurvivalDNNModel-107"><span class="linenos">107</span></a>                <span class="n">f</span> <span class="o">=</span> <span class="n">tfk</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)(</span><span class="n">f</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-108"><a href="#SurvivalDNNModel-108"><span class="linenos">108</span></a>            <span class="n">f</span> <span class="o">=</span> <span class="n">activation</span><span class="p">()(</span><span class="n">f</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-109"><a href="#SurvivalDNNModel-109"><span class="linenos">109</span></a>
</span><span id="SurvivalDNNModel-110"><a href="#SurvivalDNNModel-110"><span class="linenos">110</span></a>            <span class="c1"># Optional Dropout/Residual connections</span>
</span><span id="SurvivalDNNModel-111"><a href="#SurvivalDNNModel-111"><span class="linenos">111</span></a>            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">lastLayer</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">dropout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
</span><span id="SurvivalDNNModel-112"><a href="#SurvivalDNNModel-112"><span class="linenos">112</span></a>                <span class="n">f</span> <span class="o">=</span> <span class="n">tfk</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">)(</span><span class="n">f</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-113"><a href="#SurvivalDNNModel-113"><span class="linenos">113</span></a>            <span class="k">if</span> <span class="n">resnet</span><span class="p">:</span>
</span><span id="SurvivalDNNModel-114"><a href="#SurvivalDNNModel-114"><span class="linenos">114</span></a>                <span class="n">f</span> <span class="o">=</span> <span class="n">tfk</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Add</span><span class="p">()([</span><span class="n">f</span><span class="p">,</span> <span class="n">f0</span><span class="p">])</span>
</span><span id="SurvivalDNNModel-115"><a href="#SurvivalDNNModel-115"><span class="linenos">115</span></a>            <span class="n">f</span> <span class="o">=</span> <span class="n">activation</span><span class="p">()(</span><span class="n">f</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-116"><a href="#SurvivalDNNModel-116"><span class="linenos">116</span></a>    
</span><span id="SurvivalDNNModel-117"><a href="#SurvivalDNNModel-117"><span class="linenos">117</span></a>        <span class="c1"># Pooling layer</span>
</span><span id="SurvivalDNNModel-118"><a href="#SurvivalDNNModel-118"><span class="linenos">118</span></a>        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_dense_layer</span><span class="p">(</span>
</span><span id="SurvivalDNNModel-119"><a href="#SurvivalDNNModel-119"><span class="linenos">119</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">numSupport</span><span class="p">,</span>
</span><span id="SurvivalDNNModel-120"><a href="#SurvivalDNNModel-120"><span class="linenos">120</span></a>                    <span class="n">kernel_initializer</span><span class="o">=</span><span class="n">tfk</span><span class="o">.</span><span class="n">initializers</span><span class="o">.</span><span class="n">RandomNormal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-121"><a href="#SurvivalDNNModel-121"><span class="linenos">121</span></a>                <span class="p">)(</span><span class="n">f</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-122"><a href="#SurvivalDNNModel-122"><span class="linenos">122</span></a>
</span><span id="SurvivalDNNModel-123"><a href="#SurvivalDNNModel-123"><span class="linenos">123</span></a>        <span class="c1"># Output: Conditional probabilities of survival P(T &gt;= t|X)</span>
</span><span id="SurvivalDNNModel-124"><a href="#SurvivalDNNModel-124"><span class="linenos">124</span></a>        <span class="n">probs</span> <span class="o">=</span> <span class="n">MonotoneProbabilities</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)(</span><span class="n">f</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-125"><a href="#SurvivalDNNModel-125"><span class="linenos">125</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">tfk</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">featureLayer</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">probs</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;SurvivalModel&#39;</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-126"><a href="#SurvivalDNNModel-126"><span class="linenos">126</span></a>
</span><span id="SurvivalDNNModel-127"><a href="#SurvivalDNNModel-127"><span class="linenos">127</span></a>        <span class="c1">## Compile model</span>
</span><span id="SurvivalDNNModel-128"><a href="#SurvivalDNNModel-128"><span class="linenos">128</span></a>        <span class="k">if</span> <span class="n">optimizer</span> <span class="o">==</span> <span class="s1">&#39;adam&#39;</span><span class="p">:</span>
</span><span id="SurvivalDNNModel-129"><a href="#SurvivalDNNModel-129"><span class="linenos">129</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">tfk</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="n">clipnorm</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-130"><a href="#SurvivalDNNModel-130"><span class="linenos">130</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">delayModelCompile</span><span class="p">:</span>
</span><span id="SurvivalDNNModel-131"><a href="#SurvivalDNNModel-131"><span class="linenos">131</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_compile_model</span><span class="p">(</span>
</span><span id="SurvivalDNNModel-132"><a href="#SurvivalDNNModel-132"><span class="linenos">132</span></a>                <span class="n">optimizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="p">,</span> 
</span><span id="SurvivalDNNModel-133"><a href="#SurvivalDNNModel-133"><span class="linenos">133</span></a>                <span class="n">loss_fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span>
</span><span id="SurvivalDNNModel-134"><a href="#SurvivalDNNModel-134"><span class="linenos">134</span></a>            <span class="p">)</span>
</span><span id="SurvivalDNNModel-135"><a href="#SurvivalDNNModel-135"><span class="linenos">135</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">isCompiled</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="SurvivalDNNModel-136"><a href="#SurvivalDNNModel-136"><span class="linenos">136</span></a>
</span><span id="SurvivalDNNModel-137"><a href="#SurvivalDNNModel-137"><span class="linenos">137</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span> <span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span> 
</span><span id="SurvivalDNNModel-138"><a href="#SurvivalDNNModel-138"><span class="linenos">138</span></a>                  <span class="n">Y</span> <span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span>
</span><span id="SurvivalDNNModel-139"><a href="#SurvivalDNNModel-139"><span class="linenos">139</span></a>                  <span class="n">val_data</span> <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
</span><span id="SurvivalDNNModel-140"><a href="#SurvivalDNNModel-140"><span class="linenos">140</span></a>                  <span class="n">epochs</span> <span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> 
</span><span id="SurvivalDNNModel-141"><a href="#SurvivalDNNModel-141"><span class="linenos">141</span></a>                  <span class="n">batch_size</span> <span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> 
</span><span id="SurvivalDNNModel-142"><a href="#SurvivalDNNModel-142"><span class="linenos">142</span></a>                  <span class="n">tboard</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
</span><span id="SurvivalDNNModel-143"><a href="#SurvivalDNNModel-143"><span class="linenos">143</span></a>                  <span class="n">tboard_suffix</span> <span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
</span><span id="SurvivalDNNModel-144"><a href="#SurvivalDNNModel-144"><span class="linenos">144</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SurvivalDNNModel-145"><a href="#SurvivalDNNModel-145"><span class="linenos">145</span></a><span class="sd">        Trains the model</span>
</span><span id="SurvivalDNNModel-146"><a href="#SurvivalDNNModel-146"><span class="linenos">146</span></a>
</span><span id="SurvivalDNNModel-147"><a href="#SurvivalDNNModel-147"><span class="linenos">147</span></a><span class="sd">        Args:</span>
</span><span id="SurvivalDNNModel-148"><a href="#SurvivalDNNModel-148"><span class="linenos">148</span></a><span class="sd">            X              (array-like)    Features of shape (n, num_features)</span>
</span><span id="SurvivalDNNModel-149"><a href="#SurvivalDNNModel-149"><span class="linenos">149</span></a><span class="sd">            Y              (array-like)    Outcomes/durations of shape (n,1) or (n,)</span>
</span><span id="SurvivalDNNModel-150"><a href="#SurvivalDNNModel-150"><span class="linenos">150</span></a><span class="sd">            val_data       (tuple)         Validation data: (val_X, val_Y)</span>
</span><span id="SurvivalDNNModel-151"><a href="#SurvivalDNNModel-151"><span class="linenos">151</span></a><span class="sd">            epochs         (int)           Number of training epochs</span>
</span><span id="SurvivalDNNModel-152"><a href="#SurvivalDNNModel-152"><span class="linenos">152</span></a><span class="sd">            batch_size     (int)           Batch size</span>
</span><span id="SurvivalDNNModel-153"><a href="#SurvivalDNNModel-153"><span class="linenos">153</span></a><span class="sd">            tboard         (bool)          Whether to profile with TensorBoard</span>
</span><span id="SurvivalDNNModel-154"><a href="#SurvivalDNNModel-154"><span class="linenos">154</span></a><span class="sd">            tboard_suffix  (str)           Suffix on TensorBoard profile filenames</span>
</span><span id="SurvivalDNNModel-155"><a href="#SurvivalDNNModel-155"><span class="linenos">155</span></a>
</span><span id="SurvivalDNNModel-156"><a href="#SurvivalDNNModel-156"><span class="linenos">156</span></a><span class="sd">        Outcomes should be an array of the duration/survival times for each individual. By default, the outcome space is discretized and</span>
</span><span id="SurvivalDNNModel-157"><a href="#SurvivalDNNModel-157"><span class="linenos">157</span></a><span class="sd">        encoded into `support_bins` number of bins. Pass `None` to use all unique values as the support, e.g. for integer-valued outcomes.</span>
</span><span id="SurvivalDNNModel-158"><a href="#SurvivalDNNModel-158"><span class="linenos">158</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SurvivalDNNModel-159"><a href="#SurvivalDNNModel-159"><span class="linenos">159</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_check_compiled</span><span class="p">()</span>
</span><span id="SurvivalDNNModel-160"><a href="#SurvivalDNNModel-160"><span class="linenos">160</span></a>        
</span><span id="SurvivalDNNModel-161"><a href="#SurvivalDNNModel-161"><span class="linenos">161</span></a>        <span class="c1"># Process data</span>
</span><span id="SurvivalDNNModel-162"><a href="#SurvivalDNNModel-162"><span class="linenos">162</span></a>        <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_features</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_outcomes</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-163"><a href="#SurvivalDNNModel-163"><span class="linenos">163</span></a>        <span class="n">hasVal</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="SurvivalDNNModel-164"><a href="#SurvivalDNNModel-164"><span class="linenos">164</span></a>        <span class="k">if</span> <span class="n">val_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SurvivalDNNModel-165"><a href="#SurvivalDNNModel-165"><span class="linenos">165</span></a>            <span class="n">X_val</span><span class="p">,</span> <span class="n">Y_val</span> <span class="o">=</span> <span class="n">val_data</span>
</span><span id="SurvivalDNNModel-166"><a href="#SurvivalDNNModel-166"><span class="linenos">166</span></a>            <span class="n">X_val</span><span class="p">,</span> <span class="n">Y_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_features</span><span class="p">(</span><span class="n">X_val</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_outcomes</span><span class="p">(</span><span class="n">Y_val</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-167"><a href="#SurvivalDNNModel-167"><span class="linenos">167</span></a>            <span class="n">hasVal</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="SurvivalDNNModel-168"><a href="#SurvivalDNNModel-168"><span class="linenos">168</span></a>
</span><span id="SurvivalDNNModel-169"><a href="#SurvivalDNNModel-169"><span class="linenos">169</span></a>        <span class="c1"># Support of modeled distribution</span>
</span><span id="SurvivalDNNModel-170"><a href="#SurvivalDNNModel-170"><span class="linenos">170</span></a>        <span class="c1">## Bins: (t0, t1], (t1, t2], ..., (t_{k-1}, t-k]</span>
</span><span id="SurvivalDNNModel-171"><a href="#SurvivalDNNModel-171"><span class="linenos">171</span></a>        <span class="c1">##  where t_k = max(Y), t_0 = min(Y)</span>
</span><span id="SurvivalDNNModel-172"><a href="#SurvivalDNNModel-172"><span class="linenos">172</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">support</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SurvivalDNNModel-173"><a href="#SurvivalDNNModel-173"><span class="linenos">173</span></a>            <span class="k">if</span> <span class="n">hasVal</span><span class="p">:</span>
</span><span id="SurvivalDNNModel-174"><a href="#SurvivalDNNModel-174"><span class="linenos">174</span></a>                <span class="n">Y_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">Y</span><span class="p">,</span> <span class="n">Y_val</span><span class="p">])</span>
</span><span id="SurvivalDNNModel-175"><a href="#SurvivalDNNModel-175"><span class="linenos">175</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SurvivalDNNModel-176"><a href="#SurvivalDNNModel-176"><span class="linenos">176</span></a>                <span class="n">Y_full</span> <span class="o">=</span> <span class="n">Y</span>
</span><span id="SurvivalDNNModel-177"><a href="#SurvivalDNNModel-177"><span class="linenos">177</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">support</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">discretize_outcome_support</span><span class="p">(</span><span class="n">Y_full</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">numSupport</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-178"><a href="#SurvivalDNNModel-178"><span class="linenos">178</span></a>
</span><span id="SurvivalDNNModel-179"><a href="#SurvivalDNNModel-179"><span class="linenos">179</span></a>        <span class="c1"># Delayed compilation if necessary</span>
</span><span id="SurvivalDNNModel-180"><a href="#SurvivalDNNModel-180"><span class="linenos">180</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delayModelCompile</span><span class="p">:</span>
</span><span id="SurvivalDNNModel-181"><a href="#SurvivalDNNModel-181"><span class="linenos">181</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_compile_model</span><span class="p">(</span>
</span><span id="SurvivalDNNModel-182"><a href="#SurvivalDNNModel-182"><span class="linenos">182</span></a>                <span class="n">optimizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="p">,</span>
</span><span id="SurvivalDNNModel-183"><a href="#SurvivalDNNModel-183"><span class="linenos">183</span></a>                <span class="n">loss_fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">support</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-184"><a href="#SurvivalDNNModel-184"><span class="linenos">184</span></a>            <span class="p">)</span>
</span><span id="SurvivalDNNModel-185"><a href="#SurvivalDNNModel-185"><span class="linenos">185</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">delayModelCompile</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="SurvivalDNNModel-186"><a href="#SurvivalDNNModel-186"><span class="linenos">186</span></a>        
</span><span id="SurvivalDNNModel-187"><a href="#SurvivalDNNModel-187"><span class="linenos">187</span></a>        <span class="c1"># Encode outcomes</span>
</span><span id="SurvivalDNNModel-188"><a href="#SurvivalDNNModel-188"><span class="linenos">188</span></a>        <span class="n">Y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encode_outcomes</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-189"><a href="#SurvivalDNNModel-189"><span class="linenos">189</span></a>        <span class="k">if</span> <span class="n">hasVal</span><span class="p">:</span>
</span><span id="SurvivalDNNModel-190"><a href="#SurvivalDNNModel-190"><span class="linenos">190</span></a>            <span class="n">Y_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encode_outcomes</span><span class="p">(</span><span class="n">Y_val</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-191"><a href="#SurvivalDNNModel-191"><span class="linenos">191</span></a>            <span class="n">val_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">X_val</span><span class="p">,</span> <span class="n">Y_val</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-192"><a href="#SurvivalDNNModel-192"><span class="linenos">192</span></a>
</span><span id="SurvivalDNNModel-193"><a href="#SurvivalDNNModel-193"><span class="linenos">193</span></a>        <span class="c1"># Train model</span>
</span><span id="SurvivalDNNModel-194"><a href="#SurvivalDNNModel-194"><span class="linenos">194</span></a>        <span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span>
</span><span id="SurvivalDNNModel-195"><a href="#SurvivalDNNModel-195"><span class="linenos">195</span></a>                      <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
</span><span id="SurvivalDNNModel-196"><a href="#SurvivalDNNModel-196"><span class="linenos">196</span></a>                      <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
</span><span id="SurvivalDNNModel-197"><a href="#SurvivalDNNModel-197"><span class="linenos">197</span></a>                      <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="SurvivalDNNModel-198"><a href="#SurvivalDNNModel-198"><span class="linenos">198</span></a>                      <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="SurvivalDNNModel-199"><a href="#SurvivalDNNModel-199"><span class="linenos">199</span></a>                      <span class="n">validation_data</span><span class="o">=</span><span class="n">val_data</span><span class="p">,</span>
</span><span id="SurvivalDNNModel-200"><a href="#SurvivalDNNModel-200"><span class="linenos">200</span></a>                      <span class="n">callbacks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_callbacks</span><span class="p">(</span>
</span><span id="SurvivalDNNModel-201"><a href="#SurvivalDNNModel-201"><span class="linenos">201</span></a>                                    <span class="n">hasVal</span><span class="o">=</span><span class="n">hasVal</span><span class="p">,</span> 
</span><span id="SurvivalDNNModel-202"><a href="#SurvivalDNNModel-202"><span class="linenos">202</span></a>                                    <span class="n">tboard</span><span class="o">=</span><span class="n">tboard</span><span class="p">,</span> 
</span><span id="SurvivalDNNModel-203"><a href="#SurvivalDNNModel-203"><span class="linenos">203</span></a>                                    <span class="n">tboard_suffix</span><span class="o">=</span><span class="n">tboard_suffix</span><span class="p">,</span>
</span><span id="SurvivalDNNModel-204"><a href="#SurvivalDNNModel-204"><span class="linenos">204</span></a>                                <span class="p">)</span>
</span><span id="SurvivalDNNModel-205"><a href="#SurvivalDNNModel-205"><span class="linenos">205</span></a>                    <span class="p">)</span>
</span><span id="SurvivalDNNModel-206"><a href="#SurvivalDNNModel-206"><span class="linenos">206</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">history</span>
</span><span id="SurvivalDNNModel-207"><a href="#SurvivalDNNModel-207"><span class="linenos">207</span></a>        
</span><span id="SurvivalDNNModel-208"><a href="#SurvivalDNNModel-208"><span class="linenos">208</span></a>        <span class="c1"># Post-training: Update batch norm statistics without dropout (Hendrycks and Gimpel, 2017)</span>
</span><span id="SurvivalDNNModel-209"><a href="#SurvivalDNNModel-209"><span class="linenos">209</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batchnorm</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="SurvivalDNNModel-210"><a href="#SurvivalDNNModel-210"><span class="linenos">210</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_toggle_dropout</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-211"><a href="#SurvivalDNNModel-211"><span class="linenos">211</span></a>            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">):</span>
</span><span id="SurvivalDNNModel-212"><a href="#SurvivalDNNModel-212"><span class="linenos">212</span></a>                <span class="n">X_batch</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">idx</span><span class="p">:(</span><span class="n">idx</span><span class="o">+</span><span class="n">batch_size</span><span class="p">),</span> <span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-213"><a href="#SurvivalDNNModel-213"><span class="linenos">213</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">X_batch</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-214"><a href="#SurvivalDNNModel-214"><span class="linenos">214</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_toggle_dropout</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-215"><a href="#SurvivalDNNModel-215"><span class="linenos">215</span></a>     
</span><span id="SurvivalDNNModel-216"><a href="#SurvivalDNNModel-216"><span class="linenos">216</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">predict_survival_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">2000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
</span><span id="SurvivalDNNModel-217"><a href="#SurvivalDNNModel-217"><span class="linenos">217</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SurvivalDNNModel-218"><a href="#SurvivalDNNModel-218"><span class="linenos">218</span></a><span class="sd">        Predicts the full survival function S(t|X) = P(T &gt;= t|X)</span>
</span><span id="SurvivalDNNModel-219"><a href="#SurvivalDNNModel-219"><span class="linenos">219</span></a>
</span><span id="SurvivalDNNModel-220"><a href="#SurvivalDNNModel-220"><span class="linenos">220</span></a><span class="sd">        Returns:</span>
</span><span id="SurvivalDNNModel-221"><a href="#SurvivalDNNModel-221"><span class="linenos">221</span></a><span class="sd">            survFunc  (np.array)  Evaluation of survival function on support, shape (n, numSupport)</span>
</span><span id="SurvivalDNNModel-222"><a href="#SurvivalDNNModel-222"><span class="linenos">222</span></a><span class="sd">            support   (np.array)  Support points of t, shape (numSupport)</span>
</span><span id="SurvivalDNNModel-223"><a href="#SurvivalDNNModel-223"><span class="linenos">223</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SurvivalDNNModel-224"><a href="#SurvivalDNNModel-224"><span class="linenos">224</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_check_compiled</span><span class="p">()</span>
</span><span id="SurvivalDNNModel-225"><a href="#SurvivalDNNModel-225"><span class="linenos">225</span></a>        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_features</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-226"><a href="#SurvivalDNNModel-226"><span class="linenos">226</span></a>        
</span><span id="SurvivalDNNModel-227"><a href="#SurvivalDNNModel-227"><span class="linenos">227</span></a>        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-228"><a href="#SurvivalDNNModel-228"><span class="linenos">228</span></a>        <span class="n">survFunc</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SurvivalDNNModel-229"><a href="#SurvivalDNNModel-229"><span class="linenos">229</span></a>        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
</span><span id="SurvivalDNNModel-230"><a href="#SurvivalDNNModel-230"><span class="linenos">230</span></a>            
</span><span id="SurvivalDNNModel-231"><a href="#SurvivalDNNModel-231"><span class="linenos">231</span></a>            <span class="c1"># Estimates of conditional probabilities P(T &gt;= t | X)</span>
</span><span id="SurvivalDNNModel-232"><a href="#SurvivalDNNModel-232"><span class="linenos">232</span></a>            <span class="n">X_batch</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">idx</span><span class="p">:(</span><span class="n">idx</span><span class="o">+</span><span class="n">batch_size</span><span class="p">),</span> <span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-233"><a href="#SurvivalDNNModel-233"><span class="linenos">233</span></a>            <span class="n">condProbs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">X_batch</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="SurvivalDNNModel-234"><a href="#SurvivalDNNModel-234"><span class="linenos">234</span></a>            
</span><span id="SurvivalDNNModel-235"><a href="#SurvivalDNNModel-235"><span class="linenos">235</span></a>            <span class="c1"># Estimates of survival function</span>
</span><span id="SurvivalDNNModel-236"><a href="#SurvivalDNNModel-236"><span class="linenos">236</span></a>            <span class="n">survFunc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">condProbs</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-237"><a href="#SurvivalDNNModel-237"><span class="linenos">237</span></a>        <span class="n">survFunc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">survFunc</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-238"><a href="#SurvivalDNNModel-238"><span class="linenos">238</span></a>        <span class="n">support</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_support</span><span class="p">()</span>
</span><span id="SurvivalDNNModel-239"><a href="#SurvivalDNNModel-239"><span class="linenos">239</span></a>        <span class="k">return</span> <span class="n">survFunc</span><span class="p">,</span> <span class="n">support</span>
</span><span id="SurvivalDNNModel-240"><a href="#SurvivalDNNModel-240"><span class="linenos">240</span></a>    
</span><span id="SurvivalDNNModel-241"><a href="#SurvivalDNNModel-241"><span class="linenos">241</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">2000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="SurvivalDNNModel-242"><a href="#SurvivalDNNModel-242"><span class="linenos">242</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SurvivalDNNModel-243"><a href="#SurvivalDNNModel-243"><span class="linenos">243</span></a><span class="sd">        Estimate the expected time-to-event, E[Y|X]</span>
</span><span id="SurvivalDNNModel-244"><a href="#SurvivalDNNModel-244"><span class="linenos">244</span></a>
</span><span id="SurvivalDNNModel-245"><a href="#SurvivalDNNModel-245"><span class="linenos">245</span></a><span class="sd">        Args:</span>
</span><span id="SurvivalDNNModel-246"><a href="#SurvivalDNNModel-246"><span class="linenos">246</span></a><span class="sd">            X           (array-like)    Features of shape (n, numFeatures)</span>
</span><span id="SurvivalDNNModel-247"><a href="#SurvivalDNNModel-247"><span class="linenos">247</span></a><span class="sd">            method      (str)           Integration by &#39;midpoint&#39; or &#39;right&#39;</span>
</span><span id="SurvivalDNNModel-248"><a href="#SurvivalDNNModel-248"><span class="linenos">248</span></a><span class="sd">            batch_size  (int)           Batch size</span>
</span><span id="SurvivalDNNModel-249"><a href="#SurvivalDNNModel-249"><span class="linenos">249</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SurvivalDNNModel-250"><a href="#SurvivalDNNModel-250"><span class="linenos">250</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_check_compiled</span><span class="p">()</span>
</span><span id="SurvivalDNNModel-251"><a href="#SurvivalDNNModel-251"><span class="linenos">251</span></a>        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_features</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-252"><a href="#SurvivalDNNModel-252"><span class="linenos">252</span></a>        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-253"><a href="#SurvivalDNNModel-253"><span class="linenos">253</span></a>        <span class="n">support</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_support</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-254"><a href="#SurvivalDNNModel-254"><span class="linenos">254</span></a>        <span class="n">Y_hat</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SurvivalDNNModel-255"><a href="#SurvivalDNNModel-255"><span class="linenos">255</span></a>        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
</span><span id="SurvivalDNNModel-256"><a href="#SurvivalDNNModel-256"><span class="linenos">256</span></a>            <span class="n">X_batch</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">idx</span><span class="p">:(</span><span class="n">idx</span><span class="o">+</span><span class="n">batch_size</span><span class="p">),</span> <span class="p">:]</span>
</span><span id="SurvivalDNNModel-257"><a href="#SurvivalDNNModel-257"><span class="linenos">257</span></a>        
</span><span id="SurvivalDNNModel-258"><a href="#SurvivalDNNModel-258"><span class="linenos">258</span></a>            <span class="c1"># Estimated survival function: P(T &gt;= t| X)</span>
</span><span id="SurvivalDNNModel-259"><a href="#SurvivalDNNModel-259"><span class="linenos">259</span></a>            <span class="n">survFunc</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_survival_function</span><span class="p">(</span><span class="n">X_batch</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-260"><a href="#SurvivalDNNModel-260"><span class="linenos">260</span></a>    
</span><span id="SurvivalDNNModel-261"><a href="#SurvivalDNNModel-261"><span class="linenos">261</span></a>            <span class="c1"># Estimated PMF: P(T = t|X)</span>
</span><span id="SurvivalDNNModel-262"><a href="#SurvivalDNNModel-262"><span class="linenos">262</span></a>            <span class="n">probs</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">survFunc</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-263"><a href="#SurvivalDNNModel-263"><span class="linenos">263</span></a>    
</span><span id="SurvivalDNNModel-264"><a href="#SurvivalDNNModel-264"><span class="linenos">264</span></a>            <span class="c1"># Expected time-to-event</span>
</span><span id="SurvivalDNNModel-265"><a href="#SurvivalDNNModel-265"><span class="linenos">265</span></a>            <span class="n">Y_hat_batch</span> <span class="o">=</span> <span class="n">probs</span> <span class="o">@</span> <span class="n">support</span>
</span><span id="SurvivalDNNModel-266"><a href="#SurvivalDNNModel-266"><span class="linenos">266</span></a>            <span class="n">Y_hat</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Y_hat_batch</span><span class="p">))</span>
</span><span id="SurvivalDNNModel-267"><a href="#SurvivalDNNModel-267"><span class="linenos">267</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Y_hat</span><span class="p">))</span>
</span><span id="SurvivalDNNModel-268"><a href="#SurvivalDNNModel-268"><span class="linenos">268</span></a>
</span><span id="SurvivalDNNModel-269"><a href="#SurvivalDNNModel-269"><span class="linenos">269</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">predict_conditional</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">elapsed</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">2000</span><span class="p">):</span>
</span><span id="SurvivalDNNModel-270"><a href="#SurvivalDNNModel-270"><span class="linenos">270</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SurvivalDNNModel-271"><a href="#SurvivalDNNModel-271"><span class="linenos">271</span></a><span class="sd">        Estimate the expected time-to-event conditional on elapsed, E[Y|X, Y &gt;= elapsed]</span>
</span><span id="SurvivalDNNModel-272"><a href="#SurvivalDNNModel-272"><span class="linenos">272</span></a>
</span><span id="SurvivalDNNModel-273"><a href="#SurvivalDNNModel-273"><span class="linenos">273</span></a><span class="sd">        Args:</span>
</span><span id="SurvivalDNNModel-274"><a href="#SurvivalDNNModel-274"><span class="linenos">274</span></a><span class="sd">            X           (array-like)    Features of shape (n, numFeatures)</span>
</span><span id="SurvivalDNNModel-275"><a href="#SurvivalDNNModel-275"><span class="linenos">275</span></a><span class="sd">            elapsed     (array-like)    Array of shape (n,) indicating elapsed times</span>
</span><span id="SurvivalDNNModel-276"><a href="#SurvivalDNNModel-276"><span class="linenos">276</span></a><span class="sd">            method      (str)           Integration by &#39;midpoint&#39; or &#39;right&#39;</span>
</span><span id="SurvivalDNNModel-277"><a href="#SurvivalDNNModel-277"><span class="linenos">277</span></a><span class="sd">            batch_size  (int)           Batch size</span>
</span><span id="SurvivalDNNModel-278"><a href="#SurvivalDNNModel-278"><span class="linenos">278</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SurvivalDNNModel-279"><a href="#SurvivalDNNModel-279"><span class="linenos">279</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_check_compiled</span><span class="p">()</span>
</span><span id="SurvivalDNNModel-280"><a href="#SurvivalDNNModel-280"><span class="linenos">280</span></a>        <span class="n">X</span><span class="p">,</span> <span class="n">elapsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_features</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_outcomes</span><span class="p">(</span><span class="n">elapsed</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-281"><a href="#SurvivalDNNModel-281"><span class="linenos">281</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">elapsed</span><span class="p">):</span>
</span><span id="SurvivalDNNModel-282"><a href="#SurvivalDNNModel-282"><span class="linenos">282</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Mismatched shapes. Received </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="si">}</span><span class="s1"> features and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">elapsed</span><span class="p">)</span><span class="si">}</span><span class="s1"> times.&#39;</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-283"><a href="#SurvivalDNNModel-283"><span class="linenos">283</span></a>        <span class="n">support</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_support</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-284"><a href="#SurvivalDNNModel-284"><span class="linenos">284</span></a>        <span class="n">Y_hat</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SurvivalDNNModel-285"><a href="#SurvivalDNNModel-285"><span class="linenos">285</span></a>        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-286"><a href="#SurvivalDNNModel-286"><span class="linenos">286</span></a>        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
</span><span id="SurvivalDNNModel-287"><a href="#SurvivalDNNModel-287"><span class="linenos">287</span></a>            <span class="n">X_batch</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">idx</span><span class="p">:(</span><span class="n">idx</span><span class="o">+</span><span class="n">batch_size</span><span class="p">),</span> <span class="p">:]</span>
</span><span id="SurvivalDNNModel-288"><a href="#SurvivalDNNModel-288"><span class="linenos">288</span></a>            <span class="n">elapsed_batch</span> <span class="o">=</span> <span class="n">elapsed</span><span class="p">[</span><span class="n">idx</span><span class="p">:(</span><span class="n">idx</span><span class="o">+</span><span class="n">batch_size</span><span class="p">)]</span>
</span><span id="SurvivalDNNModel-289"><a href="#SurvivalDNNModel-289"><span class="linenos">289</span></a>        
</span><span id="SurvivalDNNModel-290"><a href="#SurvivalDNNModel-290"><span class="linenos">290</span></a>            <span class="c1"># Estimated survival function: P(T &gt;= t|X)</span>
</span><span id="SurvivalDNNModel-291"><a href="#SurvivalDNNModel-291"><span class="linenos">291</span></a>            <span class="n">survFunc</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_survival_function</span><span class="p">(</span><span class="n">X_batch</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-292"><a href="#SurvivalDNNModel-292"><span class="linenos">292</span></a>    
</span><span id="SurvivalDNNModel-293"><a href="#SurvivalDNNModel-293"><span class="linenos">293</span></a>            <span class="c1"># Estimated PMF: P(T = t|X)</span>
</span><span id="SurvivalDNNModel-294"><a href="#SurvivalDNNModel-294"><span class="linenos">294</span></a>            <span class="n">probs</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">survFunc</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-295"><a href="#SurvivalDNNModel-295"><span class="linenos">295</span></a>
</span><span id="SurvivalDNNModel-296"><a href="#SurvivalDNNModel-296"><span class="linenos">296</span></a>            <span class="c1"># Zero-indexed indicator for support bins</span>
</span><span id="SurvivalDNNModel-297"><a href="#SurvivalDNNModel-297"><span class="linenos">297</span></a>            <span class="n">elapsed_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">elapsed_batch</span><span class="p">,</span> <span class="n">support</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">support</span><span class="p">))</span>
</span><span id="SurvivalDNNModel-298"><a href="#SurvivalDNNModel-298"><span class="linenos">298</span></a>
</span><span id="SurvivalDNNModel-299"><a href="#SurvivalDNNModel-299"><span class="linenos">299</span></a>            <span class="c1"># Expected conditional time-to-event</span>
</span><span id="SurvivalDNNModel-300"><a href="#SurvivalDNNModel-300"><span class="linenos">300</span></a>            <span class="n">Y_hat_batch</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SurvivalDNNModel-301"><a href="#SurvivalDNNModel-301"><span class="linenos">301</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">bin_idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">elapsed_idx</span><span class="p">):</span>
</span><span id="SurvivalDNNModel-302"><a href="#SurvivalDNNModel-302"><span class="linenos">302</span></a>                <span class="n">truncated_probs</span> <span class="o">=</span> <span class="n">probs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">bin_idx</span><span class="p">:]</span>
</span><span id="SurvivalDNNModel-303"><a href="#SurvivalDNNModel-303"><span class="linenos">303</span></a>                <span class="n">truncated_support</span> <span class="o">=</span> <span class="n">support</span><span class="p">[</span><span class="n">bin_idx</span><span class="p">:]</span>
</span><span id="SurvivalDNNModel-304"><a href="#SurvivalDNNModel-304"><span class="linenos">304</span></a>                <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">truncated_probs</span> <span class="o">@</span> <span class="n">truncated_support</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">truncated_probs</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-305"><a href="#SurvivalDNNModel-305"><span class="linenos">305</span></a>                <span class="n">Y_hat_batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-306"><a href="#SurvivalDNNModel-306"><span class="linenos">306</span></a>            <span class="n">Y_hat</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Y_hat_batch</span><span class="p">))</span>
</span><span id="SurvivalDNNModel-307"><a href="#SurvivalDNNModel-307"><span class="linenos">307</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Y_hat</span><span class="p">))</span>
</span><span id="SurvivalDNNModel-308"><a href="#SurvivalDNNModel-308"><span class="linenos">308</span></a>
</span><span id="SurvivalDNNModel-309"><a href="#SurvivalDNNModel-309"><span class="linenos">309</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_survival_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
</span><span id="SurvivalDNNModel-310"><a href="#SurvivalDNNModel-310"><span class="linenos">310</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SurvivalDNNModel-311"><a href="#SurvivalDNNModel-311"><span class="linenos">311</span></a><span class="sd">        Plots the survival function</span>
</span><span id="SurvivalDNNModel-312"><a href="#SurvivalDNNModel-312"><span class="linenos">312</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SurvivalDNNModel-313"><a href="#SurvivalDNNModel-313"><span class="linenos">313</span></a>        <span class="n">survFunc</span><span class="p">,</span> <span class="n">support</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_survival_function</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-314"><a href="#SurvivalDNNModel-314"><span class="linenos">314</span></a>        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">survFunc</span><span class="p">):</span>
</span><span id="SurvivalDNNModel-315"><a href="#SurvivalDNNModel-315"><span class="linenos">315</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">support</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s2">&quot;post&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
</span><span id="SurvivalDNNModel-316"><a href="#SurvivalDNNModel-316"><span class="linenos">316</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Survival Probability&quot;</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-317"><a href="#SurvivalDNNModel-317"><span class="linenos">317</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time&quot;</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-318"><a href="#SurvivalDNNModel-318"><span class="linenos">318</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-319"><a href="#SurvivalDNNModel-319"><span class="linenos">319</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="SurvivalDNNModel-320"><a href="#SurvivalDNNModel-320"><span class="linenos">320</span></a>
</span><span id="SurvivalDNNModel-321"><a href="#SurvivalDNNModel-321"><span class="linenos">321</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_distribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
</span><span id="SurvivalDNNModel-322"><a href="#SurvivalDNNModel-322"><span class="linenos">322</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SurvivalDNNModel-323"><a href="#SurvivalDNNModel-323"><span class="linenos">323</span></a><span class="sd">        Plots the CDF P(T&lt;=t|X)</span>
</span><span id="SurvivalDNNModel-324"><a href="#SurvivalDNNModel-324"><span class="linenos">324</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SurvivalDNNModel-325"><a href="#SurvivalDNNModel-325"><span class="linenos">325</span></a>        <span class="n">survFunc</span><span class="p">,</span> <span class="n">support</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_survival_function</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-326"><a href="#SurvivalDNNModel-326"><span class="linenos">326</span></a>        <span class="n">F</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">survFunc</span>
</span><span id="SurvivalDNNModel-327"><a href="#SurvivalDNNModel-327"><span class="linenos">327</span></a>        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">Fn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">F</span><span class="p">):</span>
</span><span id="SurvivalDNNModel-328"><a href="#SurvivalDNNModel-328"><span class="linenos">328</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">support</span><span class="p">,</span> <span class="n">Fn</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s2">&quot;post&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
</span><span id="SurvivalDNNModel-329"><a href="#SurvivalDNNModel-329"><span class="linenos">329</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;CDF&quot;</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-330"><a href="#SurvivalDNNModel-330"><span class="linenos">330</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time&quot;</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-331"><a href="#SurvivalDNNModel-331"><span class="linenos">331</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-332"><a href="#SurvivalDNNModel-332"><span class="linenos">332</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="SurvivalDNNModel-333"><a href="#SurvivalDNNModel-333"><span class="linenos">333</span></a>
</span><span id="SurvivalDNNModel-334"><a href="#SurvivalDNNModel-334"><span class="linenos">334</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">discretize_outcome_support</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Y</span> <span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span> <span class="n">numSupport</span> <span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
</span><span id="SurvivalDNNModel-335"><a href="#SurvivalDNNModel-335"><span class="linenos">335</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SurvivalDNNModel-336"><a href="#SurvivalDNNModel-336"><span class="linenos">336</span></a><span class="sd">        Gets the discretized support of the outcome space</span>
</span><span id="SurvivalDNNModel-337"><a href="#SurvivalDNNModel-337"><span class="linenos">337</span></a>
</span><span id="SurvivalDNNModel-338"><a href="#SurvivalDNNModel-338"><span class="linenos">338</span></a><span class="sd">        Args:</span>
</span><span id="SurvivalDNNModel-339"><a href="#SurvivalDNNModel-339"><span class="linenos">339</span></a><span class="sd">            Y               (array-like)    Outcome durations of interest</span>
</span><span id="SurvivalDNNModel-340"><a href="#SurvivalDNNModel-340"><span class="linenos">340</span></a><span class="sd">            numSupport      (int)           Number of support bins. Pass `None` to use all unique integer values as support    </span>
</span><span id="SurvivalDNNModel-341"><a href="#SurvivalDNNModel-341"><span class="linenos">341</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SurvivalDNNModel-342"><a href="#SurvivalDNNModel-342"><span class="linenos">342</span></a>        <span class="k">if</span> <span class="n">numSupport</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SurvivalDNNModel-343"><a href="#SurvivalDNNModel-343"><span class="linenos">343</span></a>            <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">Y</span><span class="p">)))</span>
</span><span id="SurvivalDNNModel-344"><a href="#SurvivalDNNModel-344"><span class="linenos">344</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SurvivalDNNModel-345"><a href="#SurvivalDNNModel-345"><span class="linenos">345</span></a>            <span class="n">_</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">numSupport</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">retbins</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>   <span class="c1"># Note: These are left-open endpoints, (t0, t1], (t1, t2], ...</span>
</span><span id="SurvivalDNNModel-346"><a href="#SurvivalDNNModel-346"><span class="linenos">346</span></a>        <span class="k">return</span> <span class="n">bins</span>
</span><span id="SurvivalDNNModel-347"><a href="#SurvivalDNNModel-347"><span class="linenos">347</span></a>
</span><span id="SurvivalDNNModel-348"><a href="#SurvivalDNNModel-348"><span class="linenos">348</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_create_dense_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">kernel_initializer</span><span class="o">=</span><span class="s1">&#39;he_normal&#39;</span><span class="p">,</span> <span class="n">l2</span> <span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="SurvivalDNNModel-349"><a href="#SurvivalDNNModel-349"><span class="linenos">349</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SurvivalDNNModel-350"><a href="#SurvivalDNNModel-350"><span class="linenos">350</span></a><span class="sd">        Standard fully-connected layer</span>
</span><span id="SurvivalDNNModel-351"><a href="#SurvivalDNNModel-351"><span class="linenos">351</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SurvivalDNNModel-352"><a href="#SurvivalDNNModel-352"><span class="linenos">352</span></a>        <span class="n">regularizer</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SurvivalDNNModel-353"><a href="#SurvivalDNNModel-353"><span class="linenos">353</span></a>        <span class="k">if</span> <span class="n">l2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="SurvivalDNNModel-354"><a href="#SurvivalDNNModel-354"><span class="linenos">354</span></a>            <span class="n">regularizer</span> <span class="o">=</span> <span class="n">tfk</span><span class="o">.</span><span class="n">regularizers</span><span class="o">.</span><span class="n">L2</span><span class="p">(</span><span class="n">l2</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-355"><a href="#SurvivalDNNModel-355"><span class="linenos">355</span></a>        <span class="n">layer</span> <span class="o">=</span> <span class="n">tfk</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span>
</span><span id="SurvivalDNNModel-356"><a href="#SurvivalDNNModel-356"><span class="linenos">356</span></a>                             <span class="n">kernel_initializer</span><span class="o">=</span><span class="n">kernel_initializer</span><span class="p">,</span>
</span><span id="SurvivalDNNModel-357"><a href="#SurvivalDNNModel-357"><span class="linenos">357</span></a>                             <span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">regularizer</span><span class="p">,</span>
</span><span id="SurvivalDNNModel-358"><a href="#SurvivalDNNModel-358"><span class="linenos">358</span></a>                             <span class="n">bias_initializer</span><span class="o">=</span><span class="n">tfk</span><span class="o">.</span><span class="n">initializers</span><span class="o">.</span><span class="n">RandomNormal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">),</span>
</span><span id="SurvivalDNNModel-359"><a href="#SurvivalDNNModel-359"><span class="linenos">359</span></a>                             <span class="n">name</span><span class="o">=</span><span class="n">name</span>
</span><span id="SurvivalDNNModel-360"><a href="#SurvivalDNNModel-360"><span class="linenos">360</span></a>                            <span class="p">)</span>
</span><span id="SurvivalDNNModel-361"><a href="#SurvivalDNNModel-361"><span class="linenos">361</span></a>        <span class="k">return</span> <span class="n">layer</span>
</span><span id="SurvivalDNNModel-362"><a href="#SurvivalDNNModel-362"><span class="linenos">362</span></a>
</span><span id="SurvivalDNNModel-363"><a href="#SurvivalDNNModel-363"><span class="linenos">363</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_compile_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">loss_fn</span><span class="p">):</span>
</span><span id="SurvivalDNNModel-364"><a href="#SurvivalDNNModel-364"><span class="linenos">364</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
</span><span id="SurvivalDNNModel-365"><a href="#SurvivalDNNModel-365"><span class="linenos">365</span></a>                <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span>
</span><span id="SurvivalDNNModel-366"><a href="#SurvivalDNNModel-366"><span class="linenos">366</span></a>                <span class="n">loss</span><span class="o">=</span><span class="n">loss_fn</span>
</span><span id="SurvivalDNNModel-367"><a href="#SurvivalDNNModel-367"><span class="linenos">367</span></a>            <span class="p">)</span>
</span><span id="SurvivalDNNModel-368"><a href="#SurvivalDNNModel-368"><span class="linenos">368</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">isCompiled</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="SurvivalDNNModel-369"><a href="#SurvivalDNNModel-369"><span class="linenos">369</span></a>
</span><span id="SurvivalDNNModel-370"><a href="#SurvivalDNNModel-370"><span class="linenos">370</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_process_outcomes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
</span><span id="SurvivalDNNModel-371"><a href="#SurvivalDNNModel-371"><span class="linenos">371</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SurvivalDNNModel-372"><a href="#SurvivalDNNModel-372"><span class="linenos">372</span></a><span class="sd">        Discretizes and flattens outcomes</span>
</span><span id="SurvivalDNNModel-373"><a href="#SurvivalDNNModel-373"><span class="linenos">373</span></a><span class="sd">        Args:</span>
</span><span id="SurvivalDNNModel-374"><a href="#SurvivalDNNModel-374"><span class="linenos">374</span></a><span class="sd">            - Y  (array-like)  DataFrame/Array with a single column of shape (n,1) or (n,)</span>
</span><span id="SurvivalDNNModel-375"><a href="#SurvivalDNNModel-375"><span class="linenos">375</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SurvivalDNNModel-376"><a href="#SurvivalDNNModel-376"><span class="linenos">376</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
</span><span id="SurvivalDNNModel-377"><a href="#SurvivalDNNModel-377"><span class="linenos">377</span></a>            <span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">values</span>
</span><span id="SurvivalDNNModel-378"><a href="#SurvivalDNNModel-378"><span class="linenos">378</span></a>        <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-379"><a href="#SurvivalDNNModel-379"><span class="linenos">379</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tensor</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-380"><a href="#SurvivalDNNModel-380"><span class="linenos">380</span></a>
</span><span id="SurvivalDNNModel-381"><a href="#SurvivalDNNModel-381"><span class="linenos">381</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_encode_outcomes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
</span><span id="SurvivalDNNModel-382"><a href="#SurvivalDNNModel-382"><span class="linenos">382</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SurvivalDNNModel-383"><a href="#SurvivalDNNModel-383"><span class="linenos">383</span></a><span class="sd">        Encodes outcomes in discrete-time bins for survival/failure</span>
</span><span id="SurvivalDNNModel-384"><a href="#SurvivalDNNModel-384"><span class="linenos">384</span></a><span class="sd">        Ex.</span>
</span><span id="SurvivalDNNModel-385"><a href="#SurvivalDNNModel-385"><span class="linenos">385</span></a><span class="sd">         Y = [3,1,2] -&gt;  support = [1,2,3]</span>
</span><span id="SurvivalDNNModel-386"><a href="#SurvivalDNNModel-386"><span class="linenos">386</span></a><span class="sd">                         Y_enc = [[1,1,1],[1,0,0,],[1,1,0]]</span>
</span><span id="SurvivalDNNModel-387"><a href="#SurvivalDNNModel-387"><span class="linenos">387</span></a><span class="sd">        Returns:</span>
</span><span id="SurvivalDNNModel-388"><a href="#SurvivalDNNModel-388"><span class="linenos">388</span></a><span class="sd">            Y_encoded (np.array) of shape (n, numSupport)</span>
</span><span id="SurvivalDNNModel-389"><a href="#SurvivalDNNModel-389"><span class="linenos">389</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SurvivalDNNModel-390"><a href="#SurvivalDNNModel-390"><span class="linenos">390</span></a>        <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-391"><a href="#SurvivalDNNModel-391"><span class="linenos">391</span></a>        
</span><span id="SurvivalDNNModel-392"><a href="#SurvivalDNNModel-392"><span class="linenos">392</span></a>        <span class="c1"># Zero-indexed indicator for support bins</span>
</span><span id="SurvivalDNNModel-393"><a href="#SurvivalDNNModel-393"><span class="linenos">393</span></a>        <span class="n">Y_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">support</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">support</span><span class="p">))</span>
</span><span id="SurvivalDNNModel-394"><a href="#SurvivalDNNModel-394"><span class="linenos">394</span></a>
</span><span id="SurvivalDNNModel-395"><a href="#SurvivalDNNModel-395"><span class="linenos">395</span></a>        <span class="c1"># Encoded arrays for survival</span>
</span><span id="SurvivalDNNModel-396"><a href="#SurvivalDNNModel-396"><span class="linenos">396</span></a>        <span class="n">Y_enc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">support</span><span class="p">)))</span>
</span><span id="SurvivalDNNModel-397"><a href="#SurvivalDNNModel-397"><span class="linenos">397</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">support</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="n">Y_idx</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span>
</span><span id="SurvivalDNNModel-398"><a href="#SurvivalDNNModel-398"><span class="linenos">398</span></a>        <span class="n">Y_enc</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="SurvivalDNNModel-399"><a href="#SurvivalDNNModel-399"><span class="linenos">399</span></a>
</span><span id="SurvivalDNNModel-400"><a href="#SurvivalDNNModel-400"><span class="linenos">400</span></a>        <span class="k">return</span> <span class="n">Y_enc</span>
</span><span id="SurvivalDNNModel-401"><a href="#SurvivalDNNModel-401"><span class="linenos">401</span></a>        
</span><span id="SurvivalDNNModel-402"><a href="#SurvivalDNNModel-402"><span class="linenos">402</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_process_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
</span><span id="SurvivalDNNModel-403"><a href="#SurvivalDNNModel-403"><span class="linenos">403</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
</span><span id="SurvivalDNNModel-404"><a href="#SurvivalDNNModel-404"><span class="linenos">404</span></a>            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">values</span>
</span><span id="SurvivalDNNModel-405"><a href="#SurvivalDNNModel-405"><span class="linenos">405</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tensor</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-406"><a href="#SurvivalDNNModel-406"><span class="linenos">406</span></a>    
</span><span id="SurvivalDNNModel-407"><a href="#SurvivalDNNModel-407"><span class="linenos">407</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
</span><span id="SurvivalDNNModel-408"><a href="#SurvivalDNNModel-408"><span class="linenos">408</span></a>        <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-409"><a href="#SurvivalDNNModel-409"><span class="linenos">409</span></a>
</span><span id="SurvivalDNNModel-410"><a href="#SurvivalDNNModel-410"><span class="linenos">410</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_check_compiled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SurvivalDNNModel-411"><a href="#SurvivalDNNModel-411"><span class="linenos">411</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isCompiled</span><span class="p">:</span>
</span><span id="SurvivalDNNModel-412"><a href="#SurvivalDNNModel-412"><span class="linenos">412</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Model must be compiled first!&#39;</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-413"><a href="#SurvivalDNNModel-413"><span class="linenos">413</span></a>
</span><span id="SurvivalDNNModel-414"><a href="#SurvivalDNNModel-414"><span class="linenos">414</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hasVal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tboard</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tboard_suffix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">min_delta</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>  
</span><span id="SurvivalDNNModel-415"><a href="#SurvivalDNNModel-415"><span class="linenos">415</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SurvivalDNNModel-416"><a href="#SurvivalDNNModel-416"><span class="linenos">416</span></a><span class="sd">        Returns a list of callbacks for training</span>
</span><span id="SurvivalDNNModel-417"><a href="#SurvivalDNNModel-417"><span class="linenos">417</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SurvivalDNNModel-418"><a href="#SurvivalDNNModel-418"><span class="linenos">418</span></a>        <span class="n">callbacks</span> <span class="o">=</span> <span class="p">[</span><span class="n">CompactProgressBar</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;lr&#39;</span><span class="p">]),]</span>
</span><span id="SurvivalDNNModel-419"><a href="#SurvivalDNNModel-419"><span class="linenos">419</span></a>        <span class="k">if</span> <span class="n">hasVal</span><span class="p">:</span>
</span><span id="SurvivalDNNModel-420"><a href="#SurvivalDNNModel-420"><span class="linenos">420</span></a>            <span class="n">callbacks</span> <span class="o">+=</span> <span class="p">[</span>
</span><span id="SurvivalDNNModel-421"><a href="#SurvivalDNNModel-421"><span class="linenos">421</span></a>                <span class="n">tfk</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">EarlyStopping</span><span class="p">(</span><span class="n">min_delta</span><span class="o">=</span><span class="n">min_delta</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">restore_best_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
</span><span id="SurvivalDNNModel-422"><a href="#SurvivalDNNModel-422"><span class="linenos">422</span></a>                <span class="n">tfk</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">ReduceLROnPlateau</span><span class="p">(</span><span class="n">min_delta</span><span class="o">=</span><span class="n">min_delta</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">20</span><span class="p">),</span>
</span><span id="SurvivalDNNModel-423"><a href="#SurvivalDNNModel-423"><span class="linenos">423</span></a>            <span class="p">]</span>
</span><span id="SurvivalDNNModel-424"><a href="#SurvivalDNNModel-424"><span class="linenos">424</span></a>        <span class="k">if</span> <span class="n">tboard</span><span class="p">:</span>
</span><span id="SurvivalDNNModel-425"><a href="#SurvivalDNNModel-425"><span class="linenos">425</span></a>            <span class="n">currTime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">_%H-%M-%S&quot;</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-426"><a href="#SurvivalDNNModel-426"><span class="linenos">426</span></a>            <span class="n">log_dir</span> <span class="o">=</span> <span class="s1">&#39;logs/&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">currTime</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">modelName</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">tboard_suffix</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="SurvivalDNNModel-427"><a href="#SurvivalDNNModel-427"><span class="linenos">427</span></a>            <span class="n">callbacks</span> <span class="o">+=</span> <span class="p">[</span>
</span><span id="SurvivalDNNModel-428"><a href="#SurvivalDNNModel-428"><span class="linenos">428</span></a>                <span class="n">tfk</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">TensorBoard</span><span class="p">(</span><span class="n">log_dir</span><span class="o">=</span><span class="n">log_dir</span><span class="p">,</span> <span class="n">write_graph</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">histogram_freq</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
</span><span id="SurvivalDNNModel-429"><a href="#SurvivalDNNModel-429"><span class="linenos">429</span></a>            <span class="p">]</span>
</span><span id="SurvivalDNNModel-430"><a href="#SurvivalDNNModel-430"><span class="linenos">430</span></a>
</span><span id="SurvivalDNNModel-431"><a href="#SurvivalDNNModel-431"><span class="linenos">431</span></a>        <span class="k">return</span> <span class="n">callbacks</span>
</span><span id="SurvivalDNNModel-432"><a href="#SurvivalDNNModel-432"><span class="linenos">432</span></a>
</span><span id="SurvivalDNNModel-433"><a href="#SurvivalDNNModel-433"><span class="linenos">433</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_toggle_dropout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="SurvivalDNNModel-434"><a href="#SurvivalDNNModel-434"><span class="linenos">434</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SurvivalDNNModel-435"><a href="#SurvivalDNNModel-435"><span class="linenos">435</span></a><span class="sd">        Toggles dropout layers on and off</span>
</span><span id="SurvivalDNNModel-436"><a href="#SurvivalDNNModel-436"><span class="linenos">436</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SurvivalDNNModel-437"><a href="#SurvivalDNNModel-437"><span class="linenos">437</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_check_compiled</span><span class="p">()</span>
</span><span id="SurvivalDNNModel-438"><a href="#SurvivalDNNModel-438"><span class="linenos">438</span></a>        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
</span><span id="SurvivalDNNModel-439"><a href="#SurvivalDNNModel-439"><span class="linenos">439</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">tfk</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">):</span>
</span><span id="SurvivalDNNModel-440"><a href="#SurvivalDNNModel-440"><span class="linenos">440</span></a>                <span class="k">if</span> <span class="n">mode</span><span class="p">:</span>
</span><span id="SurvivalDNNModel-441"><a href="#SurvivalDNNModel-441"><span class="linenos">441</span></a>                    <span class="n">rate</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">)</span>
</span><span id="SurvivalDNNModel-442"><a href="#SurvivalDNNModel-442"><span class="linenos">442</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="SurvivalDNNModel-443"><a href="#SurvivalDNNModel-443"><span class="linenos">443</span></a>                    <span class="n">rate</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="SurvivalDNNModel-444"><a href="#SurvivalDNNModel-444"><span class="linenos">444</span></a>                <span class="n">layer</span><span class="o">.</span><span class="n">rate</span> <span class="o">=</span> <span class="n">rate</span>
</span><span id="SurvivalDNNModel-445"><a href="#SurvivalDNNModel-445"><span class="linenos">445</span></a>
</span><span id="SurvivalDNNModel-446"><a href="#SurvivalDNNModel-446"><span class="linenos">446</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_support</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">):</span>
</span><span id="SurvivalDNNModel-447"><a href="#SurvivalDNNModel-447"><span class="linenos">447</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SurvivalDNNModel-448"><a href="#SurvivalDNNModel-448"><span class="linenos">448</span></a><span class="sd">        Returns the support of the modeled distribution for T </span>
</span><span id="SurvivalDNNModel-449"><a href="#SurvivalDNNModel-449"><span class="linenos">449</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SurvivalDNNModel-450"><a href="#SurvivalDNNModel-450"><span class="linenos">450</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_check_compiled</span><span class="p">()</span>
</span><span id="SurvivalDNNModel-451"><a href="#SurvivalDNNModel-451"><span class="linenos">451</span></a>        <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="s1">&#39;right&#39;</span><span class="p">:</span>
</span><span id="SurvivalDNNModel-452"><a href="#SurvivalDNNModel-452"><span class="linenos">452</span></a>            <span class="n">support</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">support</span>
</span><span id="SurvivalDNNModel-453"><a href="#SurvivalDNNModel-453"><span class="linenos">453</span></a>        <span class="k">elif</span> <span class="n">method</span><span class="o">==</span><span class="s1">&#39;midpoint&#39;</span><span class="p">:</span>
</span><span id="SurvivalDNNModel-454"><a href="#SurvivalDNNModel-454"><span class="linenos">454</span></a>            <span class="n">support</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">support</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">support</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="SurvivalDNNModel-455"><a href="#SurvivalDNNModel-455"><span class="linenos">455</span></a>        <span class="k">return</span> <span class="n">support</span>
</span></pre></div>


            <div class="docstring"><p>Random Survival DNN model for modeling the distribution of time-to-events</p>
</div>


                            <div id="SurvivalDNNModel.__init__" class="classattr">
                                        <input id="SurvivalDNNModel.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">SurvivalDNNModel</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">dtype</span><span class="p">:</span> <span class="n">tensorflow</span><span class="o">.</span><span class="n">python</span><span class="o">.</span><span class="n">framework</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">DType</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span></span>)</span>

                <label class="view-source-button" for="SurvivalDNNModel.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SurvivalDNNModel.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SurvivalDNNModel.__init__-17"><a href="#SurvivalDNNModel.__init__-17"><span class="linenos">17</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">DType</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">):</span>
</span><span id="SurvivalDNNModel.__init__-18"><a href="#SurvivalDNNModel.__init__-18"><span class="linenos">18</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span>
</span><span id="SurvivalDNNModel.__init__-19"><a href="#SurvivalDNNModel.__init__-19"><span class="linenos">19</span></a>        
</span><span id="SurvivalDNNModel.__init__-20"><a href="#SurvivalDNNModel.__init__-20"><span class="linenos">20</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">modelName</span> <span class="o">=</span> <span class="s1">&#39;SurvivalModel&#39;</span>
</span><span id="SurvivalDNNModel.__init__-21"><a href="#SurvivalDNNModel.__init__-21"><span class="linenos">21</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SurvivalDNNModel.__init__-22"><a href="#SurvivalDNNModel.__init__-22"><span class="linenos">22</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">support</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SurvivalDNNModel.__init__-23"><a href="#SurvivalDNNModel.__init__-23"><span class="linenos">23</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">numSupport</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SurvivalDNNModel.__init__-24"><a href="#SurvivalDNNModel.__init__-24"><span class="linenos">24</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SurvivalDNNModel.__init__-25"><a href="#SurvivalDNNModel.__init__-25"><span class="linenos">25</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SurvivalDNNModel.__init__-26"><a href="#SurvivalDNNModel.__init__-26"><span class="linenos">26</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">delayModelCompile</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="SurvivalDNNModel.__init__-27"><a href="#SurvivalDNNModel.__init__-27"><span class="linenos">27</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">isCompiled</span> <span class="o">=</span> <span class="kc">False</span>
</span></pre></div>


    

                            </div>
                            <div id="SurvivalDNNModel.dtype" class="classattr">
                                <div class="attr variable">
            <span class="name">dtype</span>

        
    </div>
    <a class="headerlink" href="#SurvivalDNNModel.dtype"></a>
    
    

                            </div>
                            <div id="SurvivalDNNModel.modelName" class="classattr">
                                <div class="attr variable">
            <span class="name">modelName</span>

        
    </div>
    <a class="headerlink" href="#SurvivalDNNModel.modelName"></a>
    
    

                            </div>
                            <div id="SurvivalDNNModel.model" class="classattr">
                                <div class="attr variable">
            <span class="name">model</span>

        
    </div>
    <a class="headerlink" href="#SurvivalDNNModel.model"></a>
    
    

                            </div>
                            <div id="SurvivalDNNModel.support" class="classattr">
                                <div class="attr variable">
            <span class="name">support</span>

        
    </div>
    <a class="headerlink" href="#SurvivalDNNModel.support"></a>
    
    

                            </div>
                            <div id="SurvivalDNNModel.numSupport" class="classattr">
                                <div class="attr variable">
            <span class="name">numSupport</span>

        
    </div>
    <a class="headerlink" href="#SurvivalDNNModel.numSupport"></a>
    
    

                            </div>
                            <div id="SurvivalDNNModel.optimizer" class="classattr">
                                <div class="attr variable">
            <span class="name">optimizer</span>

        
    </div>
    <a class="headerlink" href="#SurvivalDNNModel.optimizer"></a>
    
    

                            </div>
                            <div id="SurvivalDNNModel.loss_fn" class="classattr">
                                <div class="attr variable">
            <span class="name">loss_fn</span>

        
    </div>
    <a class="headerlink" href="#SurvivalDNNModel.loss_fn"></a>
    
    

                            </div>
                            <div id="SurvivalDNNModel.delayModelCompile" class="classattr">
                                <div class="attr variable">
            <span class="name">delayModelCompile</span>

        
    </div>
    <a class="headerlink" href="#SurvivalDNNModel.delayModelCompile"></a>
    
    

                            </div>
                            <div id="SurvivalDNNModel.isCompiled" class="classattr">
                                <div class="attr variable">
            <span class="name">isCompiled</span>

        
    </div>
    <a class="headerlink" href="#SurvivalDNNModel.isCompiled"></a>
    
    

                            </div>
                            <div id="SurvivalDNNModel.compile" class="classattr">
                                        <input id="SurvivalDNNModel.compile-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">compile</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">numFeatures</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">numSupport</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">loss</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">python</span><span class="o">.</span><span class="n">framework</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">tensorflow</span><span class="o">.</span><span class="n">python</span><span class="o">.</span><span class="n">framework</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">tensorflow</span><span class="o">.</span><span class="n">python</span><span class="o">.</span><span class="n">framework</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="s1">&#39;loglik&#39;</span>,</span><span class="param">	<span class="n">architecture</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;resnet&#39;</span>,</span><span class="param">	<span class="n">layers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>,</span><span class="param">	activation: &lt;module &#x27;keras._tf_keras.keras.layers&#x27; from &#x27;C:\\Users\\Adam\\.conda\\envs\\survdnn\\lib\\site-packages\\keras\\_tf_keras\\keras\\layers\\__init__.py&#x27;&gt; = &lt;class &#x27;keras.src.layers.activations.leaky_relu.LeakyReLU&#x27;&gt;,</span><span class="param">	<span class="n">batchnorm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">dropout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>,</span><span class="param">	<span class="n">l2</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>,</span><span class="param">	<span class="n">optimizer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">keras</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">Optimizer</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;adam&#39;</span>,</span><span class="param">	<span class="n">lr</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">keras</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">schedules</span><span class="o">.</span><span class="n">learning_rate_schedule</span><span class="o">.</span><span class="n">LearningRateSchedule</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.001</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SurvivalDNNModel.compile-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SurvivalDNNModel.compile"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SurvivalDNNModel.compile-29"><a href="#SurvivalDNNModel.compile-29"><span class="linenos"> 29</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
</span><span id="SurvivalDNNModel.compile-30"><a href="#SurvivalDNNModel.compile-30"><span class="linenos"> 30</span></a>                <span class="n">numFeatures</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
</span><span id="SurvivalDNNModel.compile-31"><a href="#SurvivalDNNModel.compile-31"><span class="linenos"> 31</span></a>                <span class="n">numSupport</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="SurvivalDNNModel.compile-32"><a href="#SurvivalDNNModel.compile-32"><span class="linenos"> 32</span></a>                <span class="n">loss</span> <span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]</span><span class="o">=</span><span class="s1">&#39;loglik&#39;</span><span class="p">,</span>
</span><span id="SurvivalDNNModel.compile-33"><a href="#SurvivalDNNModel.compile-33"><span class="linenos"> 33</span></a>                <span class="n">architecture</span> <span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;resnet&#39;</span><span class="p">,</span> 
</span><span id="SurvivalDNNModel.compile-34"><a href="#SurvivalDNNModel.compile-34"><span class="linenos"> 34</span></a>                <span class="n">layers</span> <span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> 
</span><span id="SurvivalDNNModel.compile-35"><a href="#SurvivalDNNModel.compile-35"><span class="linenos"> 35</span></a>                <span class="n">activation</span> <span class="p">:</span> <span class="n">tfk</span><span class="o">.</span><span class="n">layers</span><span class="o">=</span><span class="n">tfk</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">,</span>
</span><span id="SurvivalDNNModel.compile-36"><a href="#SurvivalDNNModel.compile-36"><span class="linenos"> 36</span></a>                <span class="n">batchnorm</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="SurvivalDNNModel.compile-37"><a href="#SurvivalDNNModel.compile-37"><span class="linenos"> 37</span></a>                <span class="n">dropout</span> <span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> 
</span><span id="SurvivalDNNModel.compile-38"><a href="#SurvivalDNNModel.compile-38"><span class="linenos"> 38</span></a>                <span class="n">l2</span> <span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> 
</span><span id="SurvivalDNNModel.compile-39"><a href="#SurvivalDNNModel.compile-39"><span class="linenos"> 39</span></a>                <span class="n">optimizer</span> <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">tfk</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Optimizer</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;adam&#39;</span><span class="p">,</span>
</span><span id="SurvivalDNNModel.compile-40"><a href="#SurvivalDNNModel.compile-40"><span class="linenos"> 40</span></a>                <span class="n">lr</span> <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">tfk</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">schedules</span><span class="o">.</span><span class="n">LearningRateSchedule</span><span class="p">]</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
</span><span id="SurvivalDNNModel.compile-41"><a href="#SurvivalDNNModel.compile-41"><span class="linenos"> 41</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SurvivalDNNModel.compile-42"><a href="#SurvivalDNNModel.compile-42"><span class="linenos"> 42</span></a><span class="sd">        Compiles the Survival DNN model</span>
</span><span id="SurvivalDNNModel.compile-43"><a href="#SurvivalDNNModel.compile-43"><span class="linenos"> 43</span></a>
</span><span id="SurvivalDNNModel.compile-44"><a href="#SurvivalDNNModel.compile-44"><span class="linenos"> 44</span></a><span class="sd">        Args:</span>
</span><span id="SurvivalDNNModel.compile-45"><a href="#SurvivalDNNModel.compile-45"><span class="linenos"> 45</span></a><span class="sd">            numFeatures     (int)          Dimensionality of features</span>
</span><span id="SurvivalDNNModel.compile-46"><a href="#SurvivalDNNModel.compile-46"><span class="linenos"> 46</span></a><span class="sd">            numSupport      (int)          Dimensionality of discretized outcome space</span>
</span><span id="SurvivalDNNModel.compile-47"><a href="#SurvivalDNNModel.compile-47"><span class="linenos"> 47</span></a><span class="sd">            loss            (str, func)    Built-in loss function or a TensorFlow callable</span>
</span><span id="SurvivalDNNModel.compile-48"><a href="#SurvivalDNNModel.compile-48"><span class="linenos"> 48</span></a><span class="sd">            architecture    (str, list)    Architecture. See note.</span>
</span><span id="SurvivalDNNModel.compile-49"><a href="#SurvivalDNNModel.compile-49"><span class="linenos"> 49</span></a><span class="sd">            layers          (int)          Number of fixed-width hidden layers. Ignored if `architecture` != &#39;resnet&#39;</span>
</span><span id="SurvivalDNNModel.compile-50"><a href="#SurvivalDNNModel.compile-50"><span class="linenos"> 50</span></a><span class="sd">            activation      (obj)          Activation function for hidden layers</span>
</span><span id="SurvivalDNNModel.compile-51"><a href="#SurvivalDNNModel.compile-51"><span class="linenos"> 51</span></a><span class="sd">            batchnorm       (bool)         Whether to use batch normalization between each hidden layer</span>
</span><span id="SurvivalDNNModel.compile-52"><a href="#SurvivalDNNModel.compile-52"><span class="linenos"> 52</span></a><span class="sd">            dropout         (float)        Dropout rate</span>
</span><span id="SurvivalDNNModel.compile-53"><a href="#SurvivalDNNModel.compile-53"><span class="linenos"> 53</span></a><span class="sd">            l2              (float)        L2 regularization penalty on weights</span>
</span><span id="SurvivalDNNModel.compile-54"><a href="#SurvivalDNNModel.compile-54"><span class="linenos"> 54</span></a><span class="sd">            optimizer       (str, obj)     TensorFlow Keras Optimizer</span>
</span><span id="SurvivalDNNModel.compile-55"><a href="#SurvivalDNNModel.compile-55"><span class="linenos"> 55</span></a>
</span><span id="SurvivalDNNModel.compile-56"><a href="#SurvivalDNNModel.compile-56"><span class="linenos"> 56</span></a><span class="sd">        Notes: </span>
</span><span id="SurvivalDNNModel.compile-57"><a href="#SurvivalDNNModel.compile-57"><span class="linenos"> 57</span></a><span class="sd">            The `architecture` of the model defaults to a fixed-width DNN with residual connections,</span>
</span><span id="SurvivalDNNModel.compile-58"><a href="#SurvivalDNNModel.compile-58"><span class="linenos"> 58</span></a><span class="sd">            with `layers` number of hidden layers. Either the number of hidden layers must be specified,</span>
</span><span id="SurvivalDNNModel.compile-59"><a href="#SurvivalDNNModel.compile-59"><span class="linenos"> 59</span></a><span class="sd">            or an explicit architecture, e.g. [32, 32]</span>
</span><span id="SurvivalDNNModel.compile-60"><a href="#SurvivalDNNModel.compile-60"><span class="linenos"> 60</span></a>
</span><span id="SurvivalDNNModel.compile-61"><a href="#SurvivalDNNModel.compile-61"><span class="linenos"> 61</span></a><span class="sd">            Built-in loss functions include: </span>
</span><span id="SurvivalDNNModel.compile-62"><a href="#SurvivalDNNModel.compile-62"><span class="linenos"> 62</span></a><span class="sd">                - &#39;loglik&#39;       Negative loglikelihood </span>
</span><span id="SurvivalDNNModel.compile-63"><a href="#SurvivalDNNModel.compile-63"><span class="linenos"> 63</span></a><span class="sd">                - &#39;mse&#39;          MSE of point estimates of E[Y|X] </span>
</span><span id="SurvivalDNNModel.compile-64"><a href="#SurvivalDNNModel.compile-64"><span class="linenos"> 64</span></a><span class="sd">                - &#39;loglik_mse&#39;   Composite loss of loglikelihood with shrinkage towards MSE</span>
</span><span id="SurvivalDNNModel.compile-65"><a href="#SurvivalDNNModel.compile-65"><span class="linenos"> 65</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SurvivalDNNModel.compile-66"><a href="#SurvivalDNNModel.compile-66"><span class="linenos"> 66</span></a>        <span class="c1"># Parse configuration and user settings</span>
</span><span id="SurvivalDNNModel.compile-67"><a href="#SurvivalDNNModel.compile-67"><span class="linenos"> 67</span></a>        <span class="k">if</span> <span class="n">architecture</span> <span class="o">==</span> <span class="s1">&#39;resnet&#39;</span><span class="p">:</span>
</span><span id="SurvivalDNNModel.compile-68"><a href="#SurvivalDNNModel.compile-68"><span class="linenos"> 68</span></a>            <span class="n">resnet</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="SurvivalDNNModel.compile-69"><a href="#SurvivalDNNModel.compile-69"><span class="linenos"> 69</span></a>            <span class="n">numLayers</span> <span class="o">=</span> <span class="n">layers</span>
</span><span id="SurvivalDNNModel.compile-70"><a href="#SurvivalDNNModel.compile-70"><span class="linenos"> 70</span></a>            <span class="n">layerNodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">numFeatures</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numLayers</span><span class="p">)]</span>
</span><span id="SurvivalDNNModel.compile-71"><a href="#SurvivalDNNModel.compile-71"><span class="linenos"> 71</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SurvivalDNNModel.compile-72"><a href="#SurvivalDNNModel.compile-72"><span class="linenos"> 72</span></a>            <span class="n">resnet</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="SurvivalDNNModel.compile-73"><a href="#SurvivalDNNModel.compile-73"><span class="linenos"> 73</span></a>            <span class="n">numLayers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">architecture</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.compile-74"><a href="#SurvivalDNNModel.compile-74"><span class="linenos"> 74</span></a>            <span class="n">layerNodes</span> <span class="o">=</span> <span class="n">architecture</span>
</span><span id="SurvivalDNNModel.compile-75"><a href="#SurvivalDNNModel.compile-75"><span class="linenos"> 75</span></a>        <span class="k">if</span> <span class="n">loss</span> <span class="o">==</span> <span class="s1">&#39;loglik&#39;</span><span class="p">:</span>
</span><span id="SurvivalDNNModel.compile-76"><a href="#SurvivalDNNModel.compile-76"><span class="linenos"> 76</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span> <span class="o">=</span> <span class="n">loglik_loss</span>
</span><span id="SurvivalDNNModel.compile-77"><a href="#SurvivalDNNModel.compile-77"><span class="linenos"> 77</span></a>        <span class="k">elif</span> <span class="n">loss</span> <span class="o">==</span> <span class="s1">&#39;mse&#39;</span><span class="p">:</span>
</span><span id="SurvivalDNNModel.compile-78"><a href="#SurvivalDNNModel.compile-78"><span class="linenos"> 78</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">delayModelCompile</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="SurvivalDNNModel.compile-79"><a href="#SurvivalDNNModel.compile-79"><span class="linenos"> 79</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span> <span class="o">=</span> <span class="n">get_mse_loss</span>
</span><span id="SurvivalDNNModel.compile-80"><a href="#SurvivalDNNModel.compile-80"><span class="linenos"> 80</span></a>        <span class="k">elif</span> <span class="n">loss</span> <span class="o">==</span> <span class="s1">&#39;loglik_mse&#39;</span><span class="p">:</span>
</span><span id="SurvivalDNNModel.compile-81"><a href="#SurvivalDNNModel.compile-81"><span class="linenos"> 81</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">delayModelCompile</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="SurvivalDNNModel.compile-82"><a href="#SurvivalDNNModel.compile-82"><span class="linenos"> 82</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span> <span class="o">=</span> <span class="n">get_loglik_mse_loss</span>
</span><span id="SurvivalDNNModel.compile-83"><a href="#SurvivalDNNModel.compile-83"><span class="linenos"> 83</span></a>        <span class="k">elif</span> <span class="nb">callable</span><span class="p">(</span><span class="n">loss</span><span class="p">):</span>
</span><span id="SurvivalDNNModel.compile-84"><a href="#SurvivalDNNModel.compile-84"><span class="linenos"> 84</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span> <span class="o">=</span> <span class="n">loss</span>
</span><span id="SurvivalDNNModel.compile-85"><a href="#SurvivalDNNModel.compile-85"><span class="linenos"> 85</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SurvivalDNNModel.compile-86"><a href="#SurvivalDNNModel.compile-86"><span class="linenos"> 86</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Invalid loss function. Must be in [&quot;loglik&quot;, &quot;mse&quot;, &quot;loglik_mse&quot;] or a callable function&#39;</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.compile-87"><a href="#SurvivalDNNModel.compile-87"><span class="linenos"> 87</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">dropout</span>
</span><span id="SurvivalDNNModel.compile-88"><a href="#SurvivalDNNModel.compile-88"><span class="linenos"> 88</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batchnorm</span> <span class="o">=</span> <span class="n">batchnorm</span>
</span><span id="SurvivalDNNModel.compile-89"><a href="#SurvivalDNNModel.compile-89"><span class="linenos"> 89</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">numSupport</span> <span class="o">=</span> <span class="n">numSupport</span>
</span><span id="SurvivalDNNModel.compile-90"><a href="#SurvivalDNNModel.compile-90"><span class="linenos"> 90</span></a>
</span><span id="SurvivalDNNModel.compile-91"><a href="#SurvivalDNNModel.compile-91"><span class="linenos"> 91</span></a>        <span class="c1">## Model Architecture</span>
</span><span id="SurvivalDNNModel.compile-92"><a href="#SurvivalDNNModel.compile-92"><span class="linenos"> 92</span></a>
</span><span id="SurvivalDNNModel.compile-93"><a href="#SurvivalDNNModel.compile-93"><span class="linenos"> 93</span></a>        <span class="c1"># Input: Features</span>
</span><span id="SurvivalDNNModel.compile-94"><a href="#SurvivalDNNModel.compile-94"><span class="linenos"> 94</span></a>        <span class="n">featureLayer</span> <span class="o">=</span> <span class="n">tfk</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">numFeatures</span><span class="p">,))</span>
</span><span id="SurvivalDNNModel.compile-95"><a href="#SurvivalDNNModel.compile-95"><span class="linenos"> 95</span></a>        <span class="n">f0</span> <span class="o">=</span> <span class="n">featureLayer</span>
</span><span id="SurvivalDNNModel.compile-96"><a href="#SurvivalDNNModel.compile-96"><span class="linenos"> 96</span></a>        
</span><span id="SurvivalDNNModel.compile-97"><a href="#SurvivalDNNModel.compile-97"><span class="linenos"> 97</span></a>        <span class="c1"># Hidden layers</span>
</span><span id="SurvivalDNNModel.compile-98"><a href="#SurvivalDNNModel.compile-98"><span class="linenos"> 98</span></a>        <span class="n">f</span> <span class="o">=</span> <span class="n">f0</span>
</span><span id="SurvivalDNNModel.compile-99"><a href="#SurvivalDNNModel.compile-99"><span class="linenos"> 99</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">nodes</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">layerNodes</span><span class="p">):</span>
</span><span id="SurvivalDNNModel.compile-100"><a href="#SurvivalDNNModel.compile-100"><span class="linenos">100</span></a>            <span class="n">lastLayer</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="SurvivalDNNModel.compile-101"><a href="#SurvivalDNNModel.compile-101"><span class="linenos">101</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="p">(</span><span class="n">numLayers</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span> 
</span><span id="SurvivalDNNModel.compile-102"><a href="#SurvivalDNNModel.compile-102"><span class="linenos">102</span></a>                <span class="n">lastLayer</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="SurvivalDNNModel.compile-103"><a href="#SurvivalDNNModel.compile-103"><span class="linenos">103</span></a>    
</span><span id="SurvivalDNNModel.compile-104"><a href="#SurvivalDNNModel.compile-104"><span class="linenos">104</span></a>            <span class="c1"># Feedforward connections</span>
</span><span id="SurvivalDNNModel.compile-105"><a href="#SurvivalDNNModel.compile-105"><span class="linenos">105</span></a>            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_dense_layer</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">l2</span><span class="o">=</span><span class="n">l2</span><span class="p">)(</span><span class="n">f</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.compile-106"><a href="#SurvivalDNNModel.compile-106"><span class="linenos">106</span></a>            <span class="k">if</span> <span class="n">batchnorm</span><span class="p">:</span>
</span><span id="SurvivalDNNModel.compile-107"><a href="#SurvivalDNNModel.compile-107"><span class="linenos">107</span></a>                <span class="n">f</span> <span class="o">=</span> <span class="n">tfk</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)(</span><span class="n">f</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.compile-108"><a href="#SurvivalDNNModel.compile-108"><span class="linenos">108</span></a>            <span class="n">f</span> <span class="o">=</span> <span class="n">activation</span><span class="p">()(</span><span class="n">f</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.compile-109"><a href="#SurvivalDNNModel.compile-109"><span class="linenos">109</span></a>
</span><span id="SurvivalDNNModel.compile-110"><a href="#SurvivalDNNModel.compile-110"><span class="linenos">110</span></a>            <span class="c1"># Optional Dropout/Residual connections</span>
</span><span id="SurvivalDNNModel.compile-111"><a href="#SurvivalDNNModel.compile-111"><span class="linenos">111</span></a>            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">lastLayer</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">dropout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
</span><span id="SurvivalDNNModel.compile-112"><a href="#SurvivalDNNModel.compile-112"><span class="linenos">112</span></a>                <span class="n">f</span> <span class="o">=</span> <span class="n">tfk</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">)(</span><span class="n">f</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.compile-113"><a href="#SurvivalDNNModel.compile-113"><span class="linenos">113</span></a>            <span class="k">if</span> <span class="n">resnet</span><span class="p">:</span>
</span><span id="SurvivalDNNModel.compile-114"><a href="#SurvivalDNNModel.compile-114"><span class="linenos">114</span></a>                <span class="n">f</span> <span class="o">=</span> <span class="n">tfk</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Add</span><span class="p">()([</span><span class="n">f</span><span class="p">,</span> <span class="n">f0</span><span class="p">])</span>
</span><span id="SurvivalDNNModel.compile-115"><a href="#SurvivalDNNModel.compile-115"><span class="linenos">115</span></a>            <span class="n">f</span> <span class="o">=</span> <span class="n">activation</span><span class="p">()(</span><span class="n">f</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.compile-116"><a href="#SurvivalDNNModel.compile-116"><span class="linenos">116</span></a>    
</span><span id="SurvivalDNNModel.compile-117"><a href="#SurvivalDNNModel.compile-117"><span class="linenos">117</span></a>        <span class="c1"># Pooling layer</span>
</span><span id="SurvivalDNNModel.compile-118"><a href="#SurvivalDNNModel.compile-118"><span class="linenos">118</span></a>        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_dense_layer</span><span class="p">(</span>
</span><span id="SurvivalDNNModel.compile-119"><a href="#SurvivalDNNModel.compile-119"><span class="linenos">119</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">numSupport</span><span class="p">,</span>
</span><span id="SurvivalDNNModel.compile-120"><a href="#SurvivalDNNModel.compile-120"><span class="linenos">120</span></a>                    <span class="n">kernel_initializer</span><span class="o">=</span><span class="n">tfk</span><span class="o">.</span><span class="n">initializers</span><span class="o">.</span><span class="n">RandomNormal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.compile-121"><a href="#SurvivalDNNModel.compile-121"><span class="linenos">121</span></a>                <span class="p">)(</span><span class="n">f</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.compile-122"><a href="#SurvivalDNNModel.compile-122"><span class="linenos">122</span></a>
</span><span id="SurvivalDNNModel.compile-123"><a href="#SurvivalDNNModel.compile-123"><span class="linenos">123</span></a>        <span class="c1"># Output: Conditional probabilities of survival P(T &gt;= t|X)</span>
</span><span id="SurvivalDNNModel.compile-124"><a href="#SurvivalDNNModel.compile-124"><span class="linenos">124</span></a>        <span class="n">probs</span> <span class="o">=</span> <span class="n">MonotoneProbabilities</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)(</span><span class="n">f</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.compile-125"><a href="#SurvivalDNNModel.compile-125"><span class="linenos">125</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">tfk</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">featureLayer</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">probs</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;SurvivalModel&#39;</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.compile-126"><a href="#SurvivalDNNModel.compile-126"><span class="linenos">126</span></a>
</span><span id="SurvivalDNNModel.compile-127"><a href="#SurvivalDNNModel.compile-127"><span class="linenos">127</span></a>        <span class="c1">## Compile model</span>
</span><span id="SurvivalDNNModel.compile-128"><a href="#SurvivalDNNModel.compile-128"><span class="linenos">128</span></a>        <span class="k">if</span> <span class="n">optimizer</span> <span class="o">==</span> <span class="s1">&#39;adam&#39;</span><span class="p">:</span>
</span><span id="SurvivalDNNModel.compile-129"><a href="#SurvivalDNNModel.compile-129"><span class="linenos">129</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">tfk</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="n">clipnorm</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.compile-130"><a href="#SurvivalDNNModel.compile-130"><span class="linenos">130</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">delayModelCompile</span><span class="p">:</span>
</span><span id="SurvivalDNNModel.compile-131"><a href="#SurvivalDNNModel.compile-131"><span class="linenos">131</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_compile_model</span><span class="p">(</span>
</span><span id="SurvivalDNNModel.compile-132"><a href="#SurvivalDNNModel.compile-132"><span class="linenos">132</span></a>                <span class="n">optimizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="p">,</span> 
</span><span id="SurvivalDNNModel.compile-133"><a href="#SurvivalDNNModel.compile-133"><span class="linenos">133</span></a>                <span class="n">loss_fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span>
</span><span id="SurvivalDNNModel.compile-134"><a href="#SurvivalDNNModel.compile-134"><span class="linenos">134</span></a>            <span class="p">)</span>
</span><span id="SurvivalDNNModel.compile-135"><a href="#SurvivalDNNModel.compile-135"><span class="linenos">135</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">isCompiled</span> <span class="o">=</span> <span class="kc">True</span>
</span></pre></div>


            <div class="docstring"><p>Compiles the Survival DNN model</p>

<p>Args:
    numFeatures     (int)          Dimensionality of features
    numSupport      (int)          Dimensionality of discretized outcome space
    loss            (str, func)    Built-in loss function or a TensorFlow callable
    architecture    (str, list)    Architecture. See note.
    layers          (int)          Number of fixed-width hidden layers. Ignored if <code>architecture</code> != 'resnet'
    activation      (obj)          Activation function for hidden layers
    batchnorm       (bool)         Whether to use batch normalization between each hidden layer
    dropout         (float)        Dropout rate
    l2              (float)        L2 regularization penalty on weights
    optimizer       (str, obj)     TensorFlow Keras Optimizer</p>

<p>Notes: 
    The <code>architecture</code> of the model defaults to a fixed-width DNN with residual connections,
    with <code>layers</code> number of hidden layers. Either the number of hidden layers must be specified,
    or an explicit architecture, e.g. [32, 32]</p>

<pre><code>Built-in loss functions include: 
    - 'loglik'       Negative loglikelihood 
    - 'mse'          MSE of point estimates of E[Y|X] 
    - 'loglik_mse'   Composite loss of loglikelihood with shrinkage towards MSE
</code></pre>
</div>


                            </div>
                            <div id="SurvivalDNNModel.fit" class="classattr">
                                        <input id="SurvivalDNNModel.fit-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">fit</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">X</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span>,</span><span class="param">	<span class="n">Y</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span>,</span><span class="param">	<span class="n">val_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5000</span>,</span><span class="param">	<span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10000</span>,</span><span class="param">	<span class="n">tboard</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">tboard_suffix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SurvivalDNNModel.fit-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SurvivalDNNModel.fit"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SurvivalDNNModel.fit-137"><a href="#SurvivalDNNModel.fit-137"><span class="linenos">137</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span> <span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span> 
</span><span id="SurvivalDNNModel.fit-138"><a href="#SurvivalDNNModel.fit-138"><span class="linenos">138</span></a>                  <span class="n">Y</span> <span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span>
</span><span id="SurvivalDNNModel.fit-139"><a href="#SurvivalDNNModel.fit-139"><span class="linenos">139</span></a>                  <span class="n">val_data</span> <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
</span><span id="SurvivalDNNModel.fit-140"><a href="#SurvivalDNNModel.fit-140"><span class="linenos">140</span></a>                  <span class="n">epochs</span> <span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> 
</span><span id="SurvivalDNNModel.fit-141"><a href="#SurvivalDNNModel.fit-141"><span class="linenos">141</span></a>                  <span class="n">batch_size</span> <span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> 
</span><span id="SurvivalDNNModel.fit-142"><a href="#SurvivalDNNModel.fit-142"><span class="linenos">142</span></a>                  <span class="n">tboard</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
</span><span id="SurvivalDNNModel.fit-143"><a href="#SurvivalDNNModel.fit-143"><span class="linenos">143</span></a>                  <span class="n">tboard_suffix</span> <span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
</span><span id="SurvivalDNNModel.fit-144"><a href="#SurvivalDNNModel.fit-144"><span class="linenos">144</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SurvivalDNNModel.fit-145"><a href="#SurvivalDNNModel.fit-145"><span class="linenos">145</span></a><span class="sd">        Trains the model</span>
</span><span id="SurvivalDNNModel.fit-146"><a href="#SurvivalDNNModel.fit-146"><span class="linenos">146</span></a>
</span><span id="SurvivalDNNModel.fit-147"><a href="#SurvivalDNNModel.fit-147"><span class="linenos">147</span></a><span class="sd">        Args:</span>
</span><span id="SurvivalDNNModel.fit-148"><a href="#SurvivalDNNModel.fit-148"><span class="linenos">148</span></a><span class="sd">            X              (array-like)    Features of shape (n, num_features)</span>
</span><span id="SurvivalDNNModel.fit-149"><a href="#SurvivalDNNModel.fit-149"><span class="linenos">149</span></a><span class="sd">            Y              (array-like)    Outcomes/durations of shape (n,1) or (n,)</span>
</span><span id="SurvivalDNNModel.fit-150"><a href="#SurvivalDNNModel.fit-150"><span class="linenos">150</span></a><span class="sd">            val_data       (tuple)         Validation data: (val_X, val_Y)</span>
</span><span id="SurvivalDNNModel.fit-151"><a href="#SurvivalDNNModel.fit-151"><span class="linenos">151</span></a><span class="sd">            epochs         (int)           Number of training epochs</span>
</span><span id="SurvivalDNNModel.fit-152"><a href="#SurvivalDNNModel.fit-152"><span class="linenos">152</span></a><span class="sd">            batch_size     (int)           Batch size</span>
</span><span id="SurvivalDNNModel.fit-153"><a href="#SurvivalDNNModel.fit-153"><span class="linenos">153</span></a><span class="sd">            tboard         (bool)          Whether to profile with TensorBoard</span>
</span><span id="SurvivalDNNModel.fit-154"><a href="#SurvivalDNNModel.fit-154"><span class="linenos">154</span></a><span class="sd">            tboard_suffix  (str)           Suffix on TensorBoard profile filenames</span>
</span><span id="SurvivalDNNModel.fit-155"><a href="#SurvivalDNNModel.fit-155"><span class="linenos">155</span></a>
</span><span id="SurvivalDNNModel.fit-156"><a href="#SurvivalDNNModel.fit-156"><span class="linenos">156</span></a><span class="sd">        Outcomes should be an array of the duration/survival times for each individual. By default, the outcome space is discretized and</span>
</span><span id="SurvivalDNNModel.fit-157"><a href="#SurvivalDNNModel.fit-157"><span class="linenos">157</span></a><span class="sd">        encoded into `support_bins` number of bins. Pass `None` to use all unique values as the support, e.g. for integer-valued outcomes.</span>
</span><span id="SurvivalDNNModel.fit-158"><a href="#SurvivalDNNModel.fit-158"><span class="linenos">158</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SurvivalDNNModel.fit-159"><a href="#SurvivalDNNModel.fit-159"><span class="linenos">159</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_check_compiled</span><span class="p">()</span>
</span><span id="SurvivalDNNModel.fit-160"><a href="#SurvivalDNNModel.fit-160"><span class="linenos">160</span></a>        
</span><span id="SurvivalDNNModel.fit-161"><a href="#SurvivalDNNModel.fit-161"><span class="linenos">161</span></a>        <span class="c1"># Process data</span>
</span><span id="SurvivalDNNModel.fit-162"><a href="#SurvivalDNNModel.fit-162"><span class="linenos">162</span></a>        <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_features</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_outcomes</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.fit-163"><a href="#SurvivalDNNModel.fit-163"><span class="linenos">163</span></a>        <span class="n">hasVal</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="SurvivalDNNModel.fit-164"><a href="#SurvivalDNNModel.fit-164"><span class="linenos">164</span></a>        <span class="k">if</span> <span class="n">val_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SurvivalDNNModel.fit-165"><a href="#SurvivalDNNModel.fit-165"><span class="linenos">165</span></a>            <span class="n">X_val</span><span class="p">,</span> <span class="n">Y_val</span> <span class="o">=</span> <span class="n">val_data</span>
</span><span id="SurvivalDNNModel.fit-166"><a href="#SurvivalDNNModel.fit-166"><span class="linenos">166</span></a>            <span class="n">X_val</span><span class="p">,</span> <span class="n">Y_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_features</span><span class="p">(</span><span class="n">X_val</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_outcomes</span><span class="p">(</span><span class="n">Y_val</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.fit-167"><a href="#SurvivalDNNModel.fit-167"><span class="linenos">167</span></a>            <span class="n">hasVal</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="SurvivalDNNModel.fit-168"><a href="#SurvivalDNNModel.fit-168"><span class="linenos">168</span></a>
</span><span id="SurvivalDNNModel.fit-169"><a href="#SurvivalDNNModel.fit-169"><span class="linenos">169</span></a>        <span class="c1"># Support of modeled distribution</span>
</span><span id="SurvivalDNNModel.fit-170"><a href="#SurvivalDNNModel.fit-170"><span class="linenos">170</span></a>        <span class="c1">## Bins: (t0, t1], (t1, t2], ..., (t_{k-1}, t-k]</span>
</span><span id="SurvivalDNNModel.fit-171"><a href="#SurvivalDNNModel.fit-171"><span class="linenos">171</span></a>        <span class="c1">##  where t_k = max(Y), t_0 = min(Y)</span>
</span><span id="SurvivalDNNModel.fit-172"><a href="#SurvivalDNNModel.fit-172"><span class="linenos">172</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">support</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SurvivalDNNModel.fit-173"><a href="#SurvivalDNNModel.fit-173"><span class="linenos">173</span></a>            <span class="k">if</span> <span class="n">hasVal</span><span class="p">:</span>
</span><span id="SurvivalDNNModel.fit-174"><a href="#SurvivalDNNModel.fit-174"><span class="linenos">174</span></a>                <span class="n">Y_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">Y</span><span class="p">,</span> <span class="n">Y_val</span><span class="p">])</span>
</span><span id="SurvivalDNNModel.fit-175"><a href="#SurvivalDNNModel.fit-175"><span class="linenos">175</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SurvivalDNNModel.fit-176"><a href="#SurvivalDNNModel.fit-176"><span class="linenos">176</span></a>                <span class="n">Y_full</span> <span class="o">=</span> <span class="n">Y</span>
</span><span id="SurvivalDNNModel.fit-177"><a href="#SurvivalDNNModel.fit-177"><span class="linenos">177</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">support</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">discretize_outcome_support</span><span class="p">(</span><span class="n">Y_full</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">numSupport</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.fit-178"><a href="#SurvivalDNNModel.fit-178"><span class="linenos">178</span></a>
</span><span id="SurvivalDNNModel.fit-179"><a href="#SurvivalDNNModel.fit-179"><span class="linenos">179</span></a>        <span class="c1"># Delayed compilation if necessary</span>
</span><span id="SurvivalDNNModel.fit-180"><a href="#SurvivalDNNModel.fit-180"><span class="linenos">180</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delayModelCompile</span><span class="p">:</span>
</span><span id="SurvivalDNNModel.fit-181"><a href="#SurvivalDNNModel.fit-181"><span class="linenos">181</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_compile_model</span><span class="p">(</span>
</span><span id="SurvivalDNNModel.fit-182"><a href="#SurvivalDNNModel.fit-182"><span class="linenos">182</span></a>                <span class="n">optimizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="p">,</span>
</span><span id="SurvivalDNNModel.fit-183"><a href="#SurvivalDNNModel.fit-183"><span class="linenos">183</span></a>                <span class="n">loss_fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">support</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.fit-184"><a href="#SurvivalDNNModel.fit-184"><span class="linenos">184</span></a>            <span class="p">)</span>
</span><span id="SurvivalDNNModel.fit-185"><a href="#SurvivalDNNModel.fit-185"><span class="linenos">185</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">delayModelCompile</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="SurvivalDNNModel.fit-186"><a href="#SurvivalDNNModel.fit-186"><span class="linenos">186</span></a>        
</span><span id="SurvivalDNNModel.fit-187"><a href="#SurvivalDNNModel.fit-187"><span class="linenos">187</span></a>        <span class="c1"># Encode outcomes</span>
</span><span id="SurvivalDNNModel.fit-188"><a href="#SurvivalDNNModel.fit-188"><span class="linenos">188</span></a>        <span class="n">Y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encode_outcomes</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.fit-189"><a href="#SurvivalDNNModel.fit-189"><span class="linenos">189</span></a>        <span class="k">if</span> <span class="n">hasVal</span><span class="p">:</span>
</span><span id="SurvivalDNNModel.fit-190"><a href="#SurvivalDNNModel.fit-190"><span class="linenos">190</span></a>            <span class="n">Y_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encode_outcomes</span><span class="p">(</span><span class="n">Y_val</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.fit-191"><a href="#SurvivalDNNModel.fit-191"><span class="linenos">191</span></a>            <span class="n">val_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">X_val</span><span class="p">,</span> <span class="n">Y_val</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.fit-192"><a href="#SurvivalDNNModel.fit-192"><span class="linenos">192</span></a>
</span><span id="SurvivalDNNModel.fit-193"><a href="#SurvivalDNNModel.fit-193"><span class="linenos">193</span></a>        <span class="c1"># Train model</span>
</span><span id="SurvivalDNNModel.fit-194"><a href="#SurvivalDNNModel.fit-194"><span class="linenos">194</span></a>        <span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span>
</span><span id="SurvivalDNNModel.fit-195"><a href="#SurvivalDNNModel.fit-195"><span class="linenos">195</span></a>                      <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
</span><span id="SurvivalDNNModel.fit-196"><a href="#SurvivalDNNModel.fit-196"><span class="linenos">196</span></a>                      <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
</span><span id="SurvivalDNNModel.fit-197"><a href="#SurvivalDNNModel.fit-197"><span class="linenos">197</span></a>                      <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="SurvivalDNNModel.fit-198"><a href="#SurvivalDNNModel.fit-198"><span class="linenos">198</span></a>                      <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="SurvivalDNNModel.fit-199"><a href="#SurvivalDNNModel.fit-199"><span class="linenos">199</span></a>                      <span class="n">validation_data</span><span class="o">=</span><span class="n">val_data</span><span class="p">,</span>
</span><span id="SurvivalDNNModel.fit-200"><a href="#SurvivalDNNModel.fit-200"><span class="linenos">200</span></a>                      <span class="n">callbacks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_callbacks</span><span class="p">(</span>
</span><span id="SurvivalDNNModel.fit-201"><a href="#SurvivalDNNModel.fit-201"><span class="linenos">201</span></a>                                    <span class="n">hasVal</span><span class="o">=</span><span class="n">hasVal</span><span class="p">,</span> 
</span><span id="SurvivalDNNModel.fit-202"><a href="#SurvivalDNNModel.fit-202"><span class="linenos">202</span></a>                                    <span class="n">tboard</span><span class="o">=</span><span class="n">tboard</span><span class="p">,</span> 
</span><span id="SurvivalDNNModel.fit-203"><a href="#SurvivalDNNModel.fit-203"><span class="linenos">203</span></a>                                    <span class="n">tboard_suffix</span><span class="o">=</span><span class="n">tboard_suffix</span><span class="p">,</span>
</span><span id="SurvivalDNNModel.fit-204"><a href="#SurvivalDNNModel.fit-204"><span class="linenos">204</span></a>                                <span class="p">)</span>
</span><span id="SurvivalDNNModel.fit-205"><a href="#SurvivalDNNModel.fit-205"><span class="linenos">205</span></a>                    <span class="p">)</span>
</span><span id="SurvivalDNNModel.fit-206"><a href="#SurvivalDNNModel.fit-206"><span class="linenos">206</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">history</span>
</span><span id="SurvivalDNNModel.fit-207"><a href="#SurvivalDNNModel.fit-207"><span class="linenos">207</span></a>        
</span><span id="SurvivalDNNModel.fit-208"><a href="#SurvivalDNNModel.fit-208"><span class="linenos">208</span></a>        <span class="c1"># Post-training: Update batch norm statistics without dropout (Hendrycks and Gimpel, 2017)</span>
</span><span id="SurvivalDNNModel.fit-209"><a href="#SurvivalDNNModel.fit-209"><span class="linenos">209</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batchnorm</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="SurvivalDNNModel.fit-210"><a href="#SurvivalDNNModel.fit-210"><span class="linenos">210</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_toggle_dropout</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.fit-211"><a href="#SurvivalDNNModel.fit-211"><span class="linenos">211</span></a>            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">):</span>
</span><span id="SurvivalDNNModel.fit-212"><a href="#SurvivalDNNModel.fit-212"><span class="linenos">212</span></a>                <span class="n">X_batch</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">idx</span><span class="p">:(</span><span class="n">idx</span><span class="o">+</span><span class="n">batch_size</span><span class="p">),</span> <span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.fit-213"><a href="#SurvivalDNNModel.fit-213"><span class="linenos">213</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">X_batch</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.fit-214"><a href="#SurvivalDNNModel.fit-214"><span class="linenos">214</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_toggle_dropout</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Trains the model</p>

<p>Args:
    X              (array-like)    Features of shape (n, num_features)
    Y              (array-like)    Outcomes/durations of shape (n,1) or (n,)
    val_data       (tuple)         Validation data: (val_X, val_Y)
    epochs         (int)           Number of training epochs
    batch_size     (int)           Batch size
    tboard         (bool)          Whether to profile with TensorBoard
    tboard_suffix  (str)           Suffix on TensorBoard profile filenames</p>

<p>Outcomes should be an array of the duration/survival times for each individual. By default, the outcome space is discretized and
encoded into <code>support_bins</code> number of bins. Pass <code>None</code> to use all unique values as the support, e.g. for integer-valued outcomes.</p>
</div>


                            </div>
                            <div id="SurvivalDNNModel.predict_survival_function" class="classattr">
                                        <input id="SurvivalDNNModel.predict_survival_function-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">predict_survival_function</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">X</span>, </span><span class="param"><span class="n">batch_size</span><span class="o">=</span><span class="mi">2000</span></span><span class="return-annotation">) -> <span class="nb">tuple</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="SurvivalDNNModel.predict_survival_function-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SurvivalDNNModel.predict_survival_function"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SurvivalDNNModel.predict_survival_function-216"><a href="#SurvivalDNNModel.predict_survival_function-216"><span class="linenos">216</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">predict_survival_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">2000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
</span><span id="SurvivalDNNModel.predict_survival_function-217"><a href="#SurvivalDNNModel.predict_survival_function-217"><span class="linenos">217</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SurvivalDNNModel.predict_survival_function-218"><a href="#SurvivalDNNModel.predict_survival_function-218"><span class="linenos">218</span></a><span class="sd">        Predicts the full survival function S(t|X) = P(T &gt;= t|X)</span>
</span><span id="SurvivalDNNModel.predict_survival_function-219"><a href="#SurvivalDNNModel.predict_survival_function-219"><span class="linenos">219</span></a>
</span><span id="SurvivalDNNModel.predict_survival_function-220"><a href="#SurvivalDNNModel.predict_survival_function-220"><span class="linenos">220</span></a><span class="sd">        Returns:</span>
</span><span id="SurvivalDNNModel.predict_survival_function-221"><a href="#SurvivalDNNModel.predict_survival_function-221"><span class="linenos">221</span></a><span class="sd">            survFunc  (np.array)  Evaluation of survival function on support, shape (n, numSupport)</span>
</span><span id="SurvivalDNNModel.predict_survival_function-222"><a href="#SurvivalDNNModel.predict_survival_function-222"><span class="linenos">222</span></a><span class="sd">            support   (np.array)  Support points of t, shape (numSupport)</span>
</span><span id="SurvivalDNNModel.predict_survival_function-223"><a href="#SurvivalDNNModel.predict_survival_function-223"><span class="linenos">223</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SurvivalDNNModel.predict_survival_function-224"><a href="#SurvivalDNNModel.predict_survival_function-224"><span class="linenos">224</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_check_compiled</span><span class="p">()</span>
</span><span id="SurvivalDNNModel.predict_survival_function-225"><a href="#SurvivalDNNModel.predict_survival_function-225"><span class="linenos">225</span></a>        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_features</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.predict_survival_function-226"><a href="#SurvivalDNNModel.predict_survival_function-226"><span class="linenos">226</span></a>        
</span><span id="SurvivalDNNModel.predict_survival_function-227"><a href="#SurvivalDNNModel.predict_survival_function-227"><span class="linenos">227</span></a>        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.predict_survival_function-228"><a href="#SurvivalDNNModel.predict_survival_function-228"><span class="linenos">228</span></a>        <span class="n">survFunc</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SurvivalDNNModel.predict_survival_function-229"><a href="#SurvivalDNNModel.predict_survival_function-229"><span class="linenos">229</span></a>        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
</span><span id="SurvivalDNNModel.predict_survival_function-230"><a href="#SurvivalDNNModel.predict_survival_function-230"><span class="linenos">230</span></a>            
</span><span id="SurvivalDNNModel.predict_survival_function-231"><a href="#SurvivalDNNModel.predict_survival_function-231"><span class="linenos">231</span></a>            <span class="c1"># Estimates of conditional probabilities P(T &gt;= t | X)</span>
</span><span id="SurvivalDNNModel.predict_survival_function-232"><a href="#SurvivalDNNModel.predict_survival_function-232"><span class="linenos">232</span></a>            <span class="n">X_batch</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">idx</span><span class="p">:(</span><span class="n">idx</span><span class="o">+</span><span class="n">batch_size</span><span class="p">),</span> <span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.predict_survival_function-233"><a href="#SurvivalDNNModel.predict_survival_function-233"><span class="linenos">233</span></a>            <span class="n">condProbs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">X_batch</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="SurvivalDNNModel.predict_survival_function-234"><a href="#SurvivalDNNModel.predict_survival_function-234"><span class="linenos">234</span></a>            
</span><span id="SurvivalDNNModel.predict_survival_function-235"><a href="#SurvivalDNNModel.predict_survival_function-235"><span class="linenos">235</span></a>            <span class="c1"># Estimates of survival function</span>
</span><span id="SurvivalDNNModel.predict_survival_function-236"><a href="#SurvivalDNNModel.predict_survival_function-236"><span class="linenos">236</span></a>            <span class="n">survFunc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">condProbs</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.predict_survival_function-237"><a href="#SurvivalDNNModel.predict_survival_function-237"><span class="linenos">237</span></a>        <span class="n">survFunc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">survFunc</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.predict_survival_function-238"><a href="#SurvivalDNNModel.predict_survival_function-238"><span class="linenos">238</span></a>        <span class="n">support</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_support</span><span class="p">()</span>
</span><span id="SurvivalDNNModel.predict_survival_function-239"><a href="#SurvivalDNNModel.predict_survival_function-239"><span class="linenos">239</span></a>        <span class="k">return</span> <span class="n">survFunc</span><span class="p">,</span> <span class="n">support</span>
</span></pre></div>


            <div class="docstring"><p>Predicts the full survival function S(t|X) = P(T &gt;= t|X)</p>

<p>Returns:
    survFunc  (np.array)  Evaluation of survival function on support, shape (n, numSupport)
    support   (np.array)  Support points of t, shape (numSupport)</p>
</div>


                            </div>
                            <div id="SurvivalDNNModel.predict" class="classattr">
                                        <input id="SurvivalDNNModel.predict-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">predict</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">X</span>, </span><span class="param"><span class="n">method</span><span class="o">=</span><span class="s1">&#39;right&#39;</span>, </span><span class="param"><span class="n">batch_size</span><span class="o">=</span><span class="mi">2000</span></span><span class="return-annotation">) -> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>:</span></span>

                <label class="view-source-button" for="SurvivalDNNModel.predict-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SurvivalDNNModel.predict"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SurvivalDNNModel.predict-241"><a href="#SurvivalDNNModel.predict-241"><span class="linenos">241</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">2000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="SurvivalDNNModel.predict-242"><a href="#SurvivalDNNModel.predict-242"><span class="linenos">242</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SurvivalDNNModel.predict-243"><a href="#SurvivalDNNModel.predict-243"><span class="linenos">243</span></a><span class="sd">        Estimate the expected time-to-event, E[Y|X]</span>
</span><span id="SurvivalDNNModel.predict-244"><a href="#SurvivalDNNModel.predict-244"><span class="linenos">244</span></a>
</span><span id="SurvivalDNNModel.predict-245"><a href="#SurvivalDNNModel.predict-245"><span class="linenos">245</span></a><span class="sd">        Args:</span>
</span><span id="SurvivalDNNModel.predict-246"><a href="#SurvivalDNNModel.predict-246"><span class="linenos">246</span></a><span class="sd">            X           (array-like)    Features of shape (n, numFeatures)</span>
</span><span id="SurvivalDNNModel.predict-247"><a href="#SurvivalDNNModel.predict-247"><span class="linenos">247</span></a><span class="sd">            method      (str)           Integration by &#39;midpoint&#39; or &#39;right&#39;</span>
</span><span id="SurvivalDNNModel.predict-248"><a href="#SurvivalDNNModel.predict-248"><span class="linenos">248</span></a><span class="sd">            batch_size  (int)           Batch size</span>
</span><span id="SurvivalDNNModel.predict-249"><a href="#SurvivalDNNModel.predict-249"><span class="linenos">249</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SurvivalDNNModel.predict-250"><a href="#SurvivalDNNModel.predict-250"><span class="linenos">250</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_check_compiled</span><span class="p">()</span>
</span><span id="SurvivalDNNModel.predict-251"><a href="#SurvivalDNNModel.predict-251"><span class="linenos">251</span></a>        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_features</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.predict-252"><a href="#SurvivalDNNModel.predict-252"><span class="linenos">252</span></a>        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.predict-253"><a href="#SurvivalDNNModel.predict-253"><span class="linenos">253</span></a>        <span class="n">support</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_support</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.predict-254"><a href="#SurvivalDNNModel.predict-254"><span class="linenos">254</span></a>        <span class="n">Y_hat</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SurvivalDNNModel.predict-255"><a href="#SurvivalDNNModel.predict-255"><span class="linenos">255</span></a>        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
</span><span id="SurvivalDNNModel.predict-256"><a href="#SurvivalDNNModel.predict-256"><span class="linenos">256</span></a>            <span class="n">X_batch</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">idx</span><span class="p">:(</span><span class="n">idx</span><span class="o">+</span><span class="n">batch_size</span><span class="p">),</span> <span class="p">:]</span>
</span><span id="SurvivalDNNModel.predict-257"><a href="#SurvivalDNNModel.predict-257"><span class="linenos">257</span></a>        
</span><span id="SurvivalDNNModel.predict-258"><a href="#SurvivalDNNModel.predict-258"><span class="linenos">258</span></a>            <span class="c1"># Estimated survival function: P(T &gt;= t| X)</span>
</span><span id="SurvivalDNNModel.predict-259"><a href="#SurvivalDNNModel.predict-259"><span class="linenos">259</span></a>            <span class="n">survFunc</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_survival_function</span><span class="p">(</span><span class="n">X_batch</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.predict-260"><a href="#SurvivalDNNModel.predict-260"><span class="linenos">260</span></a>    
</span><span id="SurvivalDNNModel.predict-261"><a href="#SurvivalDNNModel.predict-261"><span class="linenos">261</span></a>            <span class="c1"># Estimated PMF: P(T = t|X)</span>
</span><span id="SurvivalDNNModel.predict-262"><a href="#SurvivalDNNModel.predict-262"><span class="linenos">262</span></a>            <span class="n">probs</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">survFunc</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.predict-263"><a href="#SurvivalDNNModel.predict-263"><span class="linenos">263</span></a>    
</span><span id="SurvivalDNNModel.predict-264"><a href="#SurvivalDNNModel.predict-264"><span class="linenos">264</span></a>            <span class="c1"># Expected time-to-event</span>
</span><span id="SurvivalDNNModel.predict-265"><a href="#SurvivalDNNModel.predict-265"><span class="linenos">265</span></a>            <span class="n">Y_hat_batch</span> <span class="o">=</span> <span class="n">probs</span> <span class="o">@</span> <span class="n">support</span>
</span><span id="SurvivalDNNModel.predict-266"><a href="#SurvivalDNNModel.predict-266"><span class="linenos">266</span></a>            <span class="n">Y_hat</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Y_hat_batch</span><span class="p">))</span>
</span><span id="SurvivalDNNModel.predict-267"><a href="#SurvivalDNNModel.predict-267"><span class="linenos">267</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Y_hat</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Estimate the expected time-to-event, E[Y|X]</p>

<p>Args:
    X           (array-like)    Features of shape (n, numFeatures)
    method      (str)           Integration by 'midpoint' or 'right'
    batch_size  (int)           Batch size</p>
</div>


                            </div>
                            <div id="SurvivalDNNModel.predict_conditional" class="classattr">
                                        <input id="SurvivalDNNModel.predict_conditional-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">predict_conditional</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">X</span>, </span><span class="param"><span class="n">elapsed</span>, </span><span class="param"><span class="n">method</span><span class="o">=</span><span class="s1">&#39;right&#39;</span>, </span><span class="param"><span class="n">batch_size</span><span class="o">=</span><span class="mi">2000</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SurvivalDNNModel.predict_conditional-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SurvivalDNNModel.predict_conditional"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SurvivalDNNModel.predict_conditional-269"><a href="#SurvivalDNNModel.predict_conditional-269"><span class="linenos">269</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">predict_conditional</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">elapsed</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">2000</span><span class="p">):</span>
</span><span id="SurvivalDNNModel.predict_conditional-270"><a href="#SurvivalDNNModel.predict_conditional-270"><span class="linenos">270</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SurvivalDNNModel.predict_conditional-271"><a href="#SurvivalDNNModel.predict_conditional-271"><span class="linenos">271</span></a><span class="sd">        Estimate the expected time-to-event conditional on elapsed, E[Y|X, Y &gt;= elapsed]</span>
</span><span id="SurvivalDNNModel.predict_conditional-272"><a href="#SurvivalDNNModel.predict_conditional-272"><span class="linenos">272</span></a>
</span><span id="SurvivalDNNModel.predict_conditional-273"><a href="#SurvivalDNNModel.predict_conditional-273"><span class="linenos">273</span></a><span class="sd">        Args:</span>
</span><span id="SurvivalDNNModel.predict_conditional-274"><a href="#SurvivalDNNModel.predict_conditional-274"><span class="linenos">274</span></a><span class="sd">            X           (array-like)    Features of shape (n, numFeatures)</span>
</span><span id="SurvivalDNNModel.predict_conditional-275"><a href="#SurvivalDNNModel.predict_conditional-275"><span class="linenos">275</span></a><span class="sd">            elapsed     (array-like)    Array of shape (n,) indicating elapsed times</span>
</span><span id="SurvivalDNNModel.predict_conditional-276"><a href="#SurvivalDNNModel.predict_conditional-276"><span class="linenos">276</span></a><span class="sd">            method      (str)           Integration by &#39;midpoint&#39; or &#39;right&#39;</span>
</span><span id="SurvivalDNNModel.predict_conditional-277"><a href="#SurvivalDNNModel.predict_conditional-277"><span class="linenos">277</span></a><span class="sd">            batch_size  (int)           Batch size</span>
</span><span id="SurvivalDNNModel.predict_conditional-278"><a href="#SurvivalDNNModel.predict_conditional-278"><span class="linenos">278</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SurvivalDNNModel.predict_conditional-279"><a href="#SurvivalDNNModel.predict_conditional-279"><span class="linenos">279</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_check_compiled</span><span class="p">()</span>
</span><span id="SurvivalDNNModel.predict_conditional-280"><a href="#SurvivalDNNModel.predict_conditional-280"><span class="linenos">280</span></a>        <span class="n">X</span><span class="p">,</span> <span class="n">elapsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_features</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_outcomes</span><span class="p">(</span><span class="n">elapsed</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.predict_conditional-281"><a href="#SurvivalDNNModel.predict_conditional-281"><span class="linenos">281</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">elapsed</span><span class="p">):</span>
</span><span id="SurvivalDNNModel.predict_conditional-282"><a href="#SurvivalDNNModel.predict_conditional-282"><span class="linenos">282</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Mismatched shapes. Received </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="si">}</span><span class="s1"> features and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">elapsed</span><span class="p">)</span><span class="si">}</span><span class="s1"> times.&#39;</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.predict_conditional-283"><a href="#SurvivalDNNModel.predict_conditional-283"><span class="linenos">283</span></a>        <span class="n">support</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_support</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.predict_conditional-284"><a href="#SurvivalDNNModel.predict_conditional-284"><span class="linenos">284</span></a>        <span class="n">Y_hat</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SurvivalDNNModel.predict_conditional-285"><a href="#SurvivalDNNModel.predict_conditional-285"><span class="linenos">285</span></a>        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.predict_conditional-286"><a href="#SurvivalDNNModel.predict_conditional-286"><span class="linenos">286</span></a>        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
</span><span id="SurvivalDNNModel.predict_conditional-287"><a href="#SurvivalDNNModel.predict_conditional-287"><span class="linenos">287</span></a>            <span class="n">X_batch</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">idx</span><span class="p">:(</span><span class="n">idx</span><span class="o">+</span><span class="n">batch_size</span><span class="p">),</span> <span class="p">:]</span>
</span><span id="SurvivalDNNModel.predict_conditional-288"><a href="#SurvivalDNNModel.predict_conditional-288"><span class="linenos">288</span></a>            <span class="n">elapsed_batch</span> <span class="o">=</span> <span class="n">elapsed</span><span class="p">[</span><span class="n">idx</span><span class="p">:(</span><span class="n">idx</span><span class="o">+</span><span class="n">batch_size</span><span class="p">)]</span>
</span><span id="SurvivalDNNModel.predict_conditional-289"><a href="#SurvivalDNNModel.predict_conditional-289"><span class="linenos">289</span></a>        
</span><span id="SurvivalDNNModel.predict_conditional-290"><a href="#SurvivalDNNModel.predict_conditional-290"><span class="linenos">290</span></a>            <span class="c1"># Estimated survival function: P(T &gt;= t|X)</span>
</span><span id="SurvivalDNNModel.predict_conditional-291"><a href="#SurvivalDNNModel.predict_conditional-291"><span class="linenos">291</span></a>            <span class="n">survFunc</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_survival_function</span><span class="p">(</span><span class="n">X_batch</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.predict_conditional-292"><a href="#SurvivalDNNModel.predict_conditional-292"><span class="linenos">292</span></a>    
</span><span id="SurvivalDNNModel.predict_conditional-293"><a href="#SurvivalDNNModel.predict_conditional-293"><span class="linenos">293</span></a>            <span class="c1"># Estimated PMF: P(T = t|X)</span>
</span><span id="SurvivalDNNModel.predict_conditional-294"><a href="#SurvivalDNNModel.predict_conditional-294"><span class="linenos">294</span></a>            <span class="n">probs</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">survFunc</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.predict_conditional-295"><a href="#SurvivalDNNModel.predict_conditional-295"><span class="linenos">295</span></a>
</span><span id="SurvivalDNNModel.predict_conditional-296"><a href="#SurvivalDNNModel.predict_conditional-296"><span class="linenos">296</span></a>            <span class="c1"># Zero-indexed indicator for support bins</span>
</span><span id="SurvivalDNNModel.predict_conditional-297"><a href="#SurvivalDNNModel.predict_conditional-297"><span class="linenos">297</span></a>            <span class="n">elapsed_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">elapsed_batch</span><span class="p">,</span> <span class="n">support</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">support</span><span class="p">))</span>
</span><span id="SurvivalDNNModel.predict_conditional-298"><a href="#SurvivalDNNModel.predict_conditional-298"><span class="linenos">298</span></a>
</span><span id="SurvivalDNNModel.predict_conditional-299"><a href="#SurvivalDNNModel.predict_conditional-299"><span class="linenos">299</span></a>            <span class="c1"># Expected conditional time-to-event</span>
</span><span id="SurvivalDNNModel.predict_conditional-300"><a href="#SurvivalDNNModel.predict_conditional-300"><span class="linenos">300</span></a>            <span class="n">Y_hat_batch</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SurvivalDNNModel.predict_conditional-301"><a href="#SurvivalDNNModel.predict_conditional-301"><span class="linenos">301</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">bin_idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">elapsed_idx</span><span class="p">):</span>
</span><span id="SurvivalDNNModel.predict_conditional-302"><a href="#SurvivalDNNModel.predict_conditional-302"><span class="linenos">302</span></a>                <span class="n">truncated_probs</span> <span class="o">=</span> <span class="n">probs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">bin_idx</span><span class="p">:]</span>
</span><span id="SurvivalDNNModel.predict_conditional-303"><a href="#SurvivalDNNModel.predict_conditional-303"><span class="linenos">303</span></a>                <span class="n">truncated_support</span> <span class="o">=</span> <span class="n">support</span><span class="p">[</span><span class="n">bin_idx</span><span class="p">:]</span>
</span><span id="SurvivalDNNModel.predict_conditional-304"><a href="#SurvivalDNNModel.predict_conditional-304"><span class="linenos">304</span></a>                <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">truncated_probs</span> <span class="o">@</span> <span class="n">truncated_support</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">truncated_probs</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.predict_conditional-305"><a href="#SurvivalDNNModel.predict_conditional-305"><span class="linenos">305</span></a>                <span class="n">Y_hat_batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.predict_conditional-306"><a href="#SurvivalDNNModel.predict_conditional-306"><span class="linenos">306</span></a>            <span class="n">Y_hat</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Y_hat_batch</span><span class="p">))</span>
</span><span id="SurvivalDNNModel.predict_conditional-307"><a href="#SurvivalDNNModel.predict_conditional-307"><span class="linenos">307</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Y_hat</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Estimate the expected time-to-event conditional on elapsed, E[Y|X, Y &gt;= elapsed]</p>

<p>Args:
    X           (array-like)    Features of shape (n, numFeatures)
    elapsed     (array-like)    Array of shape (n,) indicating elapsed times
    method      (str)           Integration by 'midpoint' or 'right'
    batch_size  (int)           Batch size</p>
</div>


                            </div>
                            <div id="SurvivalDNNModel.plot_survival_function" class="classattr">
                                        <input id="SurvivalDNNModel.plot_survival_function-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_survival_function</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">X</span>, </span><span class="param"><span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SurvivalDNNModel.plot_survival_function-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SurvivalDNNModel.plot_survival_function"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SurvivalDNNModel.plot_survival_function-309"><a href="#SurvivalDNNModel.plot_survival_function-309"><span class="linenos">309</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_survival_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
</span><span id="SurvivalDNNModel.plot_survival_function-310"><a href="#SurvivalDNNModel.plot_survival_function-310"><span class="linenos">310</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SurvivalDNNModel.plot_survival_function-311"><a href="#SurvivalDNNModel.plot_survival_function-311"><span class="linenos">311</span></a><span class="sd">        Plots the survival function</span>
</span><span id="SurvivalDNNModel.plot_survival_function-312"><a href="#SurvivalDNNModel.plot_survival_function-312"><span class="linenos">312</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SurvivalDNNModel.plot_survival_function-313"><a href="#SurvivalDNNModel.plot_survival_function-313"><span class="linenos">313</span></a>        <span class="n">survFunc</span><span class="p">,</span> <span class="n">support</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_survival_function</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.plot_survival_function-314"><a href="#SurvivalDNNModel.plot_survival_function-314"><span class="linenos">314</span></a>        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">survFunc</span><span class="p">):</span>
</span><span id="SurvivalDNNModel.plot_survival_function-315"><a href="#SurvivalDNNModel.plot_survival_function-315"><span class="linenos">315</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">support</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s2">&quot;post&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
</span><span id="SurvivalDNNModel.plot_survival_function-316"><a href="#SurvivalDNNModel.plot_survival_function-316"><span class="linenos">316</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Survival Probability&quot;</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.plot_survival_function-317"><a href="#SurvivalDNNModel.plot_survival_function-317"><span class="linenos">317</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time&quot;</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.plot_survival_function-318"><a href="#SurvivalDNNModel.plot_survival_function-318"><span class="linenos">318</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.plot_survival_function-319"><a href="#SurvivalDNNModel.plot_survival_function-319"><span class="linenos">319</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Plots the survival function</p>
</div>


                            </div>
                            <div id="SurvivalDNNModel.plot_distribution" class="classattr">
                                        <input id="SurvivalDNNModel.plot_distribution-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_distribution</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">X</span>, </span><span class="param"><span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SurvivalDNNModel.plot_distribution-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SurvivalDNNModel.plot_distribution"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SurvivalDNNModel.plot_distribution-321"><a href="#SurvivalDNNModel.plot_distribution-321"><span class="linenos">321</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_distribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
</span><span id="SurvivalDNNModel.plot_distribution-322"><a href="#SurvivalDNNModel.plot_distribution-322"><span class="linenos">322</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SurvivalDNNModel.plot_distribution-323"><a href="#SurvivalDNNModel.plot_distribution-323"><span class="linenos">323</span></a><span class="sd">        Plots the CDF P(T&lt;=t|X)</span>
</span><span id="SurvivalDNNModel.plot_distribution-324"><a href="#SurvivalDNNModel.plot_distribution-324"><span class="linenos">324</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SurvivalDNNModel.plot_distribution-325"><a href="#SurvivalDNNModel.plot_distribution-325"><span class="linenos">325</span></a>        <span class="n">survFunc</span><span class="p">,</span> <span class="n">support</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_survival_function</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.plot_distribution-326"><a href="#SurvivalDNNModel.plot_distribution-326"><span class="linenos">326</span></a>        <span class="n">F</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">survFunc</span>
</span><span id="SurvivalDNNModel.plot_distribution-327"><a href="#SurvivalDNNModel.plot_distribution-327"><span class="linenos">327</span></a>        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">Fn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">F</span><span class="p">):</span>
</span><span id="SurvivalDNNModel.plot_distribution-328"><a href="#SurvivalDNNModel.plot_distribution-328"><span class="linenos">328</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">support</span><span class="p">,</span> <span class="n">Fn</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s2">&quot;post&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
</span><span id="SurvivalDNNModel.plot_distribution-329"><a href="#SurvivalDNNModel.plot_distribution-329"><span class="linenos">329</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;CDF&quot;</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.plot_distribution-330"><a href="#SurvivalDNNModel.plot_distribution-330"><span class="linenos">330</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time&quot;</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.plot_distribution-331"><a href="#SurvivalDNNModel.plot_distribution-331"><span class="linenos">331</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="SurvivalDNNModel.plot_distribution-332"><a href="#SurvivalDNNModel.plot_distribution-332"><span class="linenos">332</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Plots the CDF P(T&lt;=t|X)</p>
</div>


                            </div>
                            <div id="SurvivalDNNModel.discretize_outcome_support" class="classattr">
                                        <input id="SurvivalDNNModel.discretize_outcome_support-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">discretize_outcome_support</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">Y</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">function</span> <span class="n">array</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span>,</span><span class="param">	<span class="n">numSupport</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SurvivalDNNModel.discretize_outcome_support-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SurvivalDNNModel.discretize_outcome_support"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SurvivalDNNModel.discretize_outcome_support-334"><a href="#SurvivalDNNModel.discretize_outcome_support-334"><span class="linenos">334</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">discretize_outcome_support</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Y</span> <span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span> <span class="n">numSupport</span> <span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
</span><span id="SurvivalDNNModel.discretize_outcome_support-335"><a href="#SurvivalDNNModel.discretize_outcome_support-335"><span class="linenos">335</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SurvivalDNNModel.discretize_outcome_support-336"><a href="#SurvivalDNNModel.discretize_outcome_support-336"><span class="linenos">336</span></a><span class="sd">        Gets the discretized support of the outcome space</span>
</span><span id="SurvivalDNNModel.discretize_outcome_support-337"><a href="#SurvivalDNNModel.discretize_outcome_support-337"><span class="linenos">337</span></a>
</span><span id="SurvivalDNNModel.discretize_outcome_support-338"><a href="#SurvivalDNNModel.discretize_outcome_support-338"><span class="linenos">338</span></a><span class="sd">        Args:</span>
</span><span id="SurvivalDNNModel.discretize_outcome_support-339"><a href="#SurvivalDNNModel.discretize_outcome_support-339"><span class="linenos">339</span></a><span class="sd">            Y               (array-like)    Outcome durations of interest</span>
</span><span id="SurvivalDNNModel.discretize_outcome_support-340"><a href="#SurvivalDNNModel.discretize_outcome_support-340"><span class="linenos">340</span></a><span class="sd">            numSupport      (int)           Number of support bins. Pass `None` to use all unique integer values as support    </span>
</span><span id="SurvivalDNNModel.discretize_outcome_support-341"><a href="#SurvivalDNNModel.discretize_outcome_support-341"><span class="linenos">341</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SurvivalDNNModel.discretize_outcome_support-342"><a href="#SurvivalDNNModel.discretize_outcome_support-342"><span class="linenos">342</span></a>        <span class="k">if</span> <span class="n">numSupport</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SurvivalDNNModel.discretize_outcome_support-343"><a href="#SurvivalDNNModel.discretize_outcome_support-343"><span class="linenos">343</span></a>            <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">Y</span><span class="p">)))</span>
</span><span id="SurvivalDNNModel.discretize_outcome_support-344"><a href="#SurvivalDNNModel.discretize_outcome_support-344"><span class="linenos">344</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SurvivalDNNModel.discretize_outcome_support-345"><a href="#SurvivalDNNModel.discretize_outcome_support-345"><span class="linenos">345</span></a>            <span class="n">_</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">numSupport</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">retbins</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>   <span class="c1"># Note: These are left-open endpoints, (t0, t1], (t1, t2], ...</span>
</span><span id="SurvivalDNNModel.discretize_outcome_support-346"><a href="#SurvivalDNNModel.discretize_outcome_support-346"><span class="linenos">346</span></a>        <span class="k">return</span> <span class="n">bins</span>
</span></pre></div>


            <div class="docstring"><p>Gets the discretized support of the outcome space</p>

<p>Args:
    Y               (array-like)    Outcome durations of interest
    numSupport      (int)           Number of support bins. Pass <code>None</code> to use all unique integer values as support</p>
</div>


                            </div>
                </section>
                <section id="MonotoneProbabilities">
                            <input id="MonotoneProbabilities-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">MonotoneProbabilities</span><wbr>(<span class="base">keras.src.layers.layer.Layer</span>):

                <label class="view-source-button" for="MonotoneProbabilities-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MonotoneProbabilities"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MonotoneProbabilities-457"><a href="#MonotoneProbabilities-457"><span class="linenos">457</span></a><span class="k">class</span><span class="w"> </span><span class="nc">MonotoneProbabilities</span><span class="p">(</span><span class="n">tfk</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Layer</span><span class="p">):</span>
</span><span id="MonotoneProbabilities-458"><a href="#MonotoneProbabilities-458"><span class="linenos">458</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MonotoneProbabilities-459"><a href="#MonotoneProbabilities-459"><span class="linenos">459</span></a><span class="sd">    Output layer that enforces monotonically decreasing shape restrictions as probabilities</span>
</span><span id="MonotoneProbabilities-460"><a href="#MonotoneProbabilities-460"><span class="linenos">460</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="MonotoneProbabilities-461"><a href="#MonotoneProbabilities-461"><span class="linenos">461</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">DType</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="MonotoneProbabilities-462"><a href="#MonotoneProbabilities-462"><span class="linenos">462</span></a>        <span class="nb">super</span><span class="p">(</span><span class="n">MonotoneProbabilities</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="MonotoneProbabilities-463"><a href="#MonotoneProbabilities-463"><span class="linenos">463</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="MonotoneProbabilities-464"><a href="#MonotoneProbabilities-464"><span class="linenos">464</span></a>    
</span><span id="MonotoneProbabilities-465"><a href="#MonotoneProbabilities-465"><span class="linenos">465</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="MonotoneProbabilities-466"><a href="#MonotoneProbabilities-466"><span class="linenos">466</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MonotoneProbabilities-467"><a href="#MonotoneProbabilities-467"><span class="linenos">467</span></a><span class="sd">        Inputs to layer should be all of R</span>
</span><span id="MonotoneProbabilities-468"><a href="#MonotoneProbabilities-468"><span class="linenos">468</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MonotoneProbabilities-469"><a href="#MonotoneProbabilities-469"><span class="linenos">469</span></a>        <span class="c1"># Monotonicity transformation</span>
</span><span id="MonotoneProbabilities-470"><a href="#MonotoneProbabilities-470"><span class="linenos">470</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>               <span class="c1"># Larger |x| -&gt; Smaller prob.</span>
</span><span id="MonotoneProbabilities-471"><a href="#MonotoneProbabilities-471"><span class="linenos">471</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MonotoneProbabilities-472"><a href="#MonotoneProbabilities-472"><span class="linenos">472</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">)</span>
</span><span id="MonotoneProbabilities-473"><a href="#MonotoneProbabilities-473"><span class="linenos">473</span></a>        <span class="k">return</span> <span class="n">x</span>
</span></pre></div>


            <div class="docstring"><p>Output layer that enforces monotonically decreasing shape restrictions as probabilities</p>
</div>


                            <div id="MonotoneProbabilities.__init__" class="classattr">
                                        <input id="MonotoneProbabilities.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">MonotoneProbabilities</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">dtype</span><span class="p">:</span> <span class="n">tensorflow</span><span class="o">.</span><span class="n">python</span><span class="o">.</span><span class="n">framework</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">DType</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span>,</span><span class="param">	<span class="o">**</span><span class="n">kwargs</span></span>)</span>

                <label class="view-source-button" for="MonotoneProbabilities.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MonotoneProbabilities.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MonotoneProbabilities.__init__-461"><a href="#MonotoneProbabilities.__init__-461"><span class="linenos">461</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">DType</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="MonotoneProbabilities.__init__-462"><a href="#MonotoneProbabilities.__init__-462"><span class="linenos">462</span></a>        <span class="nb">super</span><span class="p">(</span><span class="n">MonotoneProbabilities</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="MonotoneProbabilities.__init__-463"><a href="#MonotoneProbabilities.__init__-463"><span class="linenos">463</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="MonotoneProbabilities.epsilon" class="classattr">
                                <div class="attr variable">
            <span class="name">epsilon</span>

        
    </div>
    <a class="headerlink" href="#MonotoneProbabilities.epsilon"></a>
    
    

                            </div>
                            <div id="MonotoneProbabilities.call" class="classattr">
                                        <input id="MonotoneProbabilities.call-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">call</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">x</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MonotoneProbabilities.call-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MonotoneProbabilities.call"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MonotoneProbabilities.call-465"><a href="#MonotoneProbabilities.call-465"><span class="linenos">465</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="MonotoneProbabilities.call-466"><a href="#MonotoneProbabilities.call-466"><span class="linenos">466</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MonotoneProbabilities.call-467"><a href="#MonotoneProbabilities.call-467"><span class="linenos">467</span></a><span class="sd">        Inputs to layer should be all of R</span>
</span><span id="MonotoneProbabilities.call-468"><a href="#MonotoneProbabilities.call-468"><span class="linenos">468</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MonotoneProbabilities.call-469"><a href="#MonotoneProbabilities.call-469"><span class="linenos">469</span></a>        <span class="c1"># Monotonicity transformation</span>
</span><span id="MonotoneProbabilities.call-470"><a href="#MonotoneProbabilities.call-470"><span class="linenos">470</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>               <span class="c1"># Larger |x| -&gt; Smaller prob.</span>
</span><span id="MonotoneProbabilities.call-471"><a href="#MonotoneProbabilities.call-471"><span class="linenos">471</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MonotoneProbabilities.call-472"><a href="#MonotoneProbabilities.call-472"><span class="linenos">472</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">)</span>
</span><span id="MonotoneProbabilities.call-473"><a href="#MonotoneProbabilities.call-473"><span class="linenos">473</span></a>        <span class="k">return</span> <span class="n">x</span>
</span></pre></div>


            <div class="docstring"><p>Inputs to layer should be all of R</p>
</div>


                            </div>
                </section>
    </main>
</body>
</html>